<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Board Parts 관리 시스템</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <link href="https://ai-public.creatie.ai/gen_page/tailwind-custom.css" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com/3.4.5?plugins=forms@0.5.7,typography@0.5.13,aspect-ratio@0.4.2,container-queries@0.1.1"></script>
    <script>
        // 다크모드 초기화 스크립트
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
    <script src="https://ai-public.creatie.ai/gen_page/tailwind-config.min.js" data-color="#FFA500" data-border-radius="small"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <style>
        :root {
            --custom-color: #e65802; /* 밝은 오렌지색 */
        }
        .bg-custom {
            background-color: var(--custom-color);
        }
        .text-custom {
            color: var(--custom-color);
        }
        .border-custom {
            border-color: var(--custom-color);
        }
        .focus\:border-custom:focus {
            border-color: var(--custom-color);
        }
        .focus\:ring-custom:focus {
            box-shadow: 0 0 0 3px rgba(255, 165, 0, 0.5);
        }
        .button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #e65802;
            color: black;
            text-decoration: none;
            border-radius: 5px;
            text-align: center;
        }
        .button:hover {
            background-color: #FFA500;
        }
        #darkModeToggle {
            transition: all 0.3s ease;
        }
        #darkModeToggle:hover {
            transform: rotate(15deg);
        }
        .dark #darkModeToggle:hover {
            transform: rotate(-15deg);
        }
        
        /* 다크모드 스타일 추가 - 강력한 다크모드 스타일 */
        .dark {
            color-scheme: dark;
        }
        
        .dark body {
            background-color: #121212 !important;
            color: #ffffff !important;
        }

        .dark .bg-orange-50,
        .dark .bg-orange-100,
        .dark .bg-white {
            background-color: #1e1e1e !important;
            color: #f0f0f0 !important;
        }

        .dark h1, .dark h2, .dark h3, .dark p, 
        .dark label, .dark text, .dark div {
            color: #f0f0f0 !important;
        }
        
        .dark input, .dark select, .dark textarea {
            background-color: #2d2d2d !important;
            color: #ffffff !important;
            border-color: #444444 !important;
        }
        
        .dark .shadow, .dark .shadow-lg, .dark .shadow-sm {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5) !important;
        }

        /* 사이드바 다크모드 스타일 */
        .dark aside.w-64 {
            background-color: #374151 !important; /* bg-gray-700과 동일한 색상 */
        }

        .dark .button {
            background-color: #374151 !important; /* bg-gray-700과 동일 */
            color: #f3f4f6 !important; /* 텍스트 색상 */
        }

        .dark .button:hover {
            background-color: #4b5563 !important; /* bg-gray-600과 동일 */
        }

        .dark .button.bg-yellow-500 {
            background-color: #4338ca !important; /* 선택된 버튼은 인디고-700으로 */
            color: #f3f4f6 !important;
        }

        /* 다크모드에서 채팅 히스토리 테이블 텍스트 강제 흰색 */
        .dark .dark\:bg-gray-900 td {
            color: white !important;
            font-weight: 500 !important;
        }

        .dark #chatHistoryTable td {
            color: white !important;
            font-weight: 500 !important;
        }

        /* 차트 클릭 가능 표시 */
        #stockChart {
            cursor: pointer;
        }
        
        /* 카테고리 모달 스타일 개선 */
        #categoryModal {
            backdrop-filter: blur(4px);
        }
        
        #categoryModal .bg-white, 
        #categoryModal .dark\\:bg-gray-900 {
            transition: all 0.3s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        /* 다크모드에서 카테고리 모달의 모든 텍스트를 무조건 흰색으로 강제 적용 */
        .dark #categoryModal,
        .dark #categoryModal *,
        .dark #categoryModal *::before,
        .dark #categoryModal *::after,
        .dark #categoryModal > *,
        .dark #categoryModal > * > *,
        .dark #categoryModal > * > * > *,
        .dark #categoryModal > * > * > * > *,
        .dark #categoryModal > * > * > * > * > * {
            color: #ffffff !important;
            fill: #ffffff !important;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;
        }
        
        /* 절대적으로 모든 요소 강제 흰색 */
        .dark #categoryModal h1,
        .dark #categoryModal h2, 
        .dark #categoryModal h3,
        .dark #categoryModal h4,
        .dark #categoryModal h5,
        .dark #categoryModal h6,
        .dark #categoryModal p,
        .dark #categoryModal span,
        .dark #categoryModal div,
        .dark #categoryModal button,
        .dark #categoryModal i,
        .dark #categoryModal strong,
        .dark #categoryModal b,
        .dark #categoryModal em,
        .dark #categoryModal label,
        .dark #categoryModal a,
        .dark #categoryModal li,
        .dark #categoryModal ul,
        .dark #categoryModal ol,
        .dark #categoryModal td,
        .dark #categoryModal th,
        .dark #categoryModal tr,
        .dark #categoryModal table,
        .dark #categoryModal input,
        .dark #categoryModal textarea,
        .dark #categoryModal select,
        .dark #categoryModal option {
            color: #ffffff !important;
            fill: #ffffff !important;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;
        }
        
        /* 모든 가능한 색상 클래스 무시 */
        .dark #categoryModal [class*="text-"],
        .dark #categoryModal [class*="color-"],
        .dark #categoryModal .text-white,
        .dark #categoryModal .text-black,
        .dark #categoryModal .text-red-50,
        .dark #categoryModal .text-red-100,
        .dark #categoryModal .text-red-200,
        .dark #categoryModal .text-red-300,
        .dark #categoryModal .text-red-400,
        .dark #categoryModal .text-red-500,
        .dark #categoryModal .text-red-600,
        .dark #categoryModal .text-red-700,
        .dark #categoryModal .text-red-800,
        .dark #categoryModal .text-red-900,
        .dark #categoryModal .text-gray-50,
        .dark #categoryModal .text-gray-100,
        .dark #categoryModal .text-gray-200,
        .dark #categoryModal .text-gray-300,
        .dark #categoryModal .text-gray-400,
        .dark #categoryModal .text-gray-500,
        .dark #categoryModal .text-gray-600,
        .dark #categoryModal .text-gray-700,
        .dark #categoryModal .text-gray-800,
        .dark #categoryModal .text-gray-900,
        .dark #categoryModal .dark\\:text-white,
        .dark #categoryModal .dark\\:text-gray-100,
        .dark #categoryModal .dark\\:text-gray-200,
        .dark #categoryModal .dark\\:text-gray-300,
        .dark #categoryModal .dark\\:text-gray-400,
        .dark #categoryModal .dark\\:text-gray-500,
        .dark #categoryModal .dark\\:text-gray-600,
        .dark #categoryModal .dark\\:text-gray-700,
        .dark #categoryModal .dark\\:text-gray-800,
        .dark #categoryModal .dark\\:text-gray-900 {
            color: #ffffff !important;
            fill: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8) !important;
        }
        
        /* ECharts 차트 내부 모든 텍스트 강제 흰색 */
        .dark #categoryChart,
        .dark #categoryChart *,
        .dark #categoryChart text,
        .dark #categoryChart tspan,
        .dark #categoryChart g,
        .dark #categoryChart svg,
        .dark #categoryChart path,
        .dark #categoryChart rect,
        .dark #categoryChart circle {
            fill: #ffffff !important;
            color: #ffffff !important;
            stroke: #ffffff !important;
        }
        
        /* 버튼과 아이콘 절대 흰색 */
        .dark #categoryModal button,
        .dark #categoryModal button *,
        .dark #categoryModal i,
        .dark #categoryModal .fas,
        .dark #categoryModal .far,
        .dark #categoryModal .fab,
        .dark #categoryModal .fa {
            color: #ffffff !important;
            fill: #ffffff !important;
        }
        
        /* 최종 안전장치 - 모든 것을 흰색으로 */
        .dark #categoryModal {
            --tw-text-opacity: 1 !important;
        }
        
        .dark #categoryModal * {
            --tw-text-opacity: 1 !important;
        }

        /* ECharts 범례 텍스트 스타일 강제 적용 */
        .dark div[class*="echarts"] text,
        .dark div[class*="echarts"] tspan {
            fill: #ffffff !important;
        }
        
        /* ECharts 범례 비활성화 상태 텍스트 */
        .dark div[class*="echarts"] .echarts-legend-inactive text,
        .dark div[class*="echarts"] .echarts-legend-inactive tspan {
            fill: #000000 !important;
        }

        /* ECharts Canvas 내부 SVG 텍스트 요소들 */
        .dark canvas + svg text,
        .dark canvas + svg tspan,
        .dark div[data-zr-dom-id] text,
        .dark div[data-zr-dom-id] tspan,
        .dark canvas[data-zr-dom-id] + svg text,
        .dark canvas[data-zr-dom-id] + svg tspan {
            fill: #ffffff !important;
        }

        /* 더 구체적인 ECharts 범례 선택자 */
        .dark .echarts-legend text,
        .dark .echarts-legend tspan,
        .dark g[class*="legend"] text,
        .dark g[class*="legend"] tspan,
        .dark text[class*="legend"],
        .dark tspan[class*="legend"] {
            fill: #ffffff !important;
        }

        /* 범례 비활성화 상태 */
        .dark .echarts-legend-inactive text,
        .dark .echarts-legend-inactive tspan,
        .dark g[class*="legend"][class*="inactive"] text,
        .dark g[class*="legend"][class*="inactive"] tspan {
            fill: #000000 !important;
        }

    </style>
</head>
<body class="min-h-screen bg-orange-50 dark:bg-orange-100">
    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-orange-600 text-white dark:bg-orange-500">
            <a href="#" id="homeRefreshButton" class="block text-center p-2 hover:bg-orange-700 transition-all duration-300">
                <img src="nepesark_2-removebg-preview.png" alt="HOME" class="h-30 w-auto transition-transform duration-300 hover:scale-105" />
            </a>
            <a href="index.html" class="button w-full text-left bg-yellow-500 text-black mb-1">📙 Parts 재고관리</a>
            <a href="Parts_입출고.html" class="button w-full text-left bg-orange-500 hover:bg-yellow-500 text-black mb-1">🚚 Parts 입출고 이력</a>
            <a href="재고목록.html" class="button w-full text-left bg-orange-500 hover:bg-yellow-500 text-black mb-1">📊 재고목록 관리</a>
        </aside>
        <main class="flex-1 overflow-y-auto">
            <header class="bg-orange-100 shadow-sm dark:bg-orange-200">
                <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-semibold text-orange-900 dark:text-orange-800">장비솔루션 파트 Board Parts 관리 시스템</h1>
                        <div class="flex items-center space-x-4">
                            <!-- 사용자 정보 표시 -->
                            <div class="flex items-center space-x-2">
                                <span id="currentUser" class="text-sm text-orange-700 dark:text-orange-800">로딩 중...</span>
                                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                    <i class="fas fa-sign-out-alt mr-1"></i>로그아웃
                                </button>
                            </div>

                            <button id="darkModeToggle" class="rounded-full p-2 bg-orange-200 hover:bg-orange-300 dark:bg-orange-700 dark:hover:bg-orange-600 transition-colors">
                                <!-- 라이트 모드에서는 달 아이콘, 다크모드에서는 해 아이콘 -->
                                <i id="moonIcon" class="fas fa-moon text-orange-800"></i>
                                <i id="sunIcon" class="fas fa-sun text-orange-800" style="display: none;"></i>
                            </button>

                            <div class="relative">
                                <button id="notificationButton" class="!rounded-button flex items-center text-orange-700 hover:text-orange-900 dark:text-orange-600 dark:hover:text-orange-800">
                                    <i class="fas fa-bell text-xl"></i>
                                </button>
                                <span id="notificationCounter" class="absolute -top-1 -right-1 bg-orange-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">0</span>
                                
                                <!-- 알림 드롭다운 메뉴 추가 -->
                                <div id="notificationDropdown" class="absolute right-0 mt-2 w-80 bg-white rounded-md shadow-lg overflow-hidden z-20 hidden dark:bg-gray-800">
                                    <div class="py-2 px-3 bg-orange-100 dark:bg-gray-700">
                                        <div class="flex justify-between items-center">
                                            <h3 class="text-sm font-medium text-orange-900 dark:text-gray-200">실시간 알림</h3>
                                            <span id="dropdownNotificationCounter" class="bg-orange-500 text-white text-xs rounded-full px-2 py-1">0</span>
                                        </div>
                                    </div>
                                    <div id="notificationList" class="max-h-80 overflow-y-auto">
                                        <!-- 알림 목록은 JavaScript로 동적 생성됨 -->
                                        <div class="text-center text-gray-500 dark:text-gray-400 py-6">알림이 없습니다</div>
                                    </div>
                                    <div class="py-2 px-3 bg-gray-100 text-right dark:bg-gray-900">
                                        <button id="clearAllNotifications" class="text-xs text-orange-600 hover:text-orange-800 dark:text-orange-400 dark:hover:text-orange-300">모두 확인</button>
                                    </div>
                                </div>           
                            </div>
                            <!-- 메신저 아이콘 -->
                            <div class="relative ml-4">
                                <button id="messengerButton" class="!rounded-button flex items-center text-orange-700 hover:text-orange-900 dark:text-orange-600 dark:hover:text-orange-800">
                                    <i class="fas fa-comment-dots text-xl"></i>
                                </button>
                                <span id="messageCounter" class="absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid grid-cols-3 gap-6 mb-8">
                    <div class="bg-orange-50 rounded-lg shadow p-6 dark:bg-orange-100">
                        <h3 class="text-lg font-medium mb-4 dark:text-orange-900">연도&월별 출고 현황</h3>
                        <div id="stockChart" class="h-64"></div>
                    </div>

                    <div class="bg-orange-50 rounded-lg shadow p-6 dark:bg-orange-100">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium dark:text-orange-900">카테고리별 구매금액</h3>
                            <select id="categoryYearSelect" class="px-3 py-1 text-sm border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="all">전체</option>
                            </select>
                        </div>
                        <div id="flowChart" class="h-64"></div>
                        <div class="mt-4 pt-3 border-t border-gray-300 dark:border-gray-600">
                            <div class="text-center">
                                <span id="totalCostLabel" class="text-sm font-medium">총 구매 비용: </span>
                                <span id="totalPurchaseCost" class="text-lg font-bold">₩0</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-orange-50 rounded-lg shadow p-6 dark:bg-orange-100">
                        <h3 class="text-lg font-medium mb-4 dark:text-orange-900">실시간 알림</h3>
                        <div class="space-y-4">
                            <div class="flex items-start"><div class="flex-shrink-0 w-8 h-8 rounded-full bg-orange-200 flex items-center justify-center"><i class="fas fa-box text-orange-600"></i></div><div class="ml-3"><p class="text-sm font-medium">TLP3914 출고 처리</p><p class="text-xs text-orange-500">2025-02-26</p></div></div>
                            <div class="flex items-start"><div class="flex-shrink-0 w-8 h-8 rounded-full bg-orange-200 flex items-center justify-center"><i class="fas fa-box text-orange-600"></i></div><div class="ml-3"><p class="text-sm font-medium">R1005F/4.99K 출고 처리</p><p class="text-xs text-orange-500">2025-02-27</p></div></div>
                            <div class="flex items-start"><div class="flex-shrink-0 w-8 h-8 rounded-full bg-orange-200 flex items-center justify-center"><i class="fas fa-box text-orange-600"></i></div><div class="ml-3"><p class="text-sm font-medium">22uF/35V 출고 처리</p><p class="text-xs text-orange-500">2025-02-27</p></div></div>
                        </div>
                    </div>
                    
                </div>
                <div class="bg-orange-50 rounded-lg shadow dark:bg-orange-100">
                    
                </div>                <!-- Board별 부품 사용량 차트 -->
                <div class="bg-orange-50 rounded-lg shadow p-6 dark:bg-orange-100 mb-8">
                    <!-- 제목과 날짜 필터를 flex로 배치 -->
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium dark:text-orange-900">Board별 부품 사용량</h3>
                        <!-- 날짜 범위 필터 -->
                        <div class="flex items-center space-x-2 bg-orange-200 dark:bg-orange-700 rounded-lg p-2">
                            <i class="fas fa-calendar-alt text-orange-800 dark:text-orange-200"></i>
                            <input type="date" id="startDateFilter" class="text-sm border-none bg-transparent text-orange-800 dark:text-orange-200 focus:outline-none cursor-pointer" title="시작 날짜">
                            <span class="text-orange-800 dark:text-orange-200">~</span>
                            <input type="date" id="endDateFilter" class="text-sm border-none bg-transparent text-orange-800 dark:text-orange-200 focus:outline-none cursor-pointer" title="종료 날짜">
                            <button id="applyDateFilter" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                적용
                            </button>
                            <button id="resetDateFilter" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                초기화
                            </button>
                        </div>
                    </div>

                    <div id="integratedChart" class="h-96"></div>                </div>
                
            </div>
        </div>
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-96">
            <h2 class="text-lg font-semibold mb-4">새 부품 등록</h2>
            <form id="partForm">
                <div class="mb-4">
                    <label for="location" class="block text-sm font-medium text-gray-700">위치</label>
                    <input type="text" id="location" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-custom focus:border-custom" required>
                </div>
                <div class="mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-700">품목</label>
                    <input type="text" id="name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-custom focus:border-custom" required>
                </div>
                <div class="mb-4">
                    <label for="company" class="block text-sm font-medium text-gray-700">구매처</label>
                    <input type="text" id="company" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-custom focus:border-custom" required>
                </div>
                <div class="mb-4">
                    <label for="minStock" class="block text-sm font-medium text-gray-700">최소 재고 개수</label>
                    <input type="number" id="minStock" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-custom focus:border-custom" min="1" step="1" required>
                </div>
                <div class="mb-4">
                    <label for="inDate" class="block text-sm font-medium text-gray-700">입고일</label>
                    <input type="date" id="inDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-custom focus:border-custom">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancelButton" class="px-4 py-2 bg-gray-300 rounded-md hover:bg-gray-400">취소</button>
                    <button type="submit" class="px-4 py-2 bg-custom text-white rounded-md hover:bg-orange-700">등록</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 카테고리별 출고 분포 모달 -->
    <div id="categoryModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-40">
        <div class="bg-white rounded-lg shadow-lg p-6 w-[600px] max-w-[90vw] max-h-[90vh] overflow-y-auto dark:bg-gray-900 border-2 border-gray-200 dark:border-gray-600" style="color: #ffffff !important;">
            <div class="flex justify-between items-center mb-4">
                <h2 id="categoryModalTitle" class="text-xl font-bold text-white" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;">카테고리별 출고 현황</h2>
                <button id="closeCategoryModal" class="text-white hover:text-white transition-colors p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" style="color: #ffffff !important;">
                    <i class="fas fa-times text-xl" style="color: #ffffff !important;"></i>
                </button>
            </div>
            <div class="mb-4 bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                <div id="categoryChart" class="h-80" style="color: #ffffff !important;"></div>
            </div>
            <div id="categoryDetails" class="mt-4 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600">
                <h4 class="text-sm font-bold text-white mb-3" style="color: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;">📊 상세 정보</h4>
                <div id="categoryList" class="space-y-2 text-sm" style="color: #ffffff !important;">
                    <!-- 카테고리별 상세 정보가 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 채팅 모달 (여기에 추가) -->
    <div id="chatModal" class="fixed bottom-4 right-4 w-96 bg-white rounded-lg shadow-lg overflow-hidden z-30 hidden dark:bg-gray-800">
        <div class="flex justify-between items-center bg-orange-500 dark:bg-orange-700 text-white p-3">
            <h3 class="font-medium">실시간 채팅</h3>
            <div class="flex space-x-2">
                <button id="minimizeChatButton" class="hover:bg-orange-600 dark:hover:bg-orange-800 p-1 rounded">
                    <i class="fas fa-minus"></i>
                </button>
                <button id="closeChatButton" class="hover:bg-orange-600 dark:hover:bg-orange-800 p-1 rounded">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div id="chatMessages" class="h-80 overflow-y-auto p-4 space-y-3">
            <div class="flex flex-col space-y-1">
                <div class="flex items-end">
                    <div class="flex flex-col space-y-2 text-xs max-w-xs mx-2 order-2 items-start">
                        <div><span class="px-4 py-2 rounded-lg inline-block rounded-bl-none bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-200">전달사항을 입력하세요.</span></div>
                    </div>
                    <img src="https://via.placeholder.com/30" alt="관리자" class="w-6 h-6 rounded-full order-1">
                </div>
            </div>
        </div>
        <div class="border-t border-gray-200 dark:border-gray-700 p-3">
            <div class="flex items-center space-x-2">
                <input type="text" id="chatInput" class="flex-1 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-orange-500" placeholder="메시지를 입력하세요...">
                <button id="sendMessageButton" class="bg-orange-500 hover:bg-orange-600 text-white rounded-lg p-2 dark:bg-orange-700 dark:hover:bg-orange-800">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // 알림 버튼 및 드롭다운 기능
        function setupNotifications() {
            const notificationButton = document.getElementById('notificationButton');
            const notificationDropdown = document.getElementById('notificationDropdown');
            const notificationCounter = document.getElementById('notificationCounter');
            const dropdownNotificationCounter = document.getElementById('dropdownNotificationCounter');
            const notificationList = document.getElementById('notificationList');
            const clearAllNotifications = document.getElementById('clearAllNotifications');
            
            // 알림 버튼 클릭 이벤트
            if (notificationButton) {
                notificationButton.addEventListener('click', () => {
                    notificationDropdown.classList.toggle('hidden');
                    
                    // 드롭다운 외부 클릭 시 닫기
                    document.addEventListener('click', function closeDropdown(e) {
                        if (!notificationDropdown.contains(e.target) && !notificationButton.contains(e.target)) {
                            notificationDropdown.classList.add('hidden');
                            document.removeEventListener('click', closeDropdown);
                        }
                    });
                });
            }
            
            // 모두 확인 버튼 클릭 이벤트
            if (clearAllNotifications) {
                clearAllNotifications.addEventListener('click', () => {
                    notificationDropdown.classList.add('hidden');
                    // 알림 확인 처리 (추후 데이터베이스 연동 시 활용)
                    // localStorage.setItem('lastNotificationCheck', new Date().toISOString());
                    
                    // 알림 카운터 초기화
                    notificationCounter.textContent = '0';
                    dropdownNotificationCounter.textContent = '0';
                    
                    // 알림 목록 비우기
                    notificationList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-6">알림이 없습니다</div>';
                });
            }
        }

        // 알림 드롭다운 내용 업데이트 함수
        function updateNotificationDropdown(lowStockItems) {
            const notificationList = document.getElementById('notificationList');
            const notificationCounter = document.getElementById('notificationCounter');
            const dropdownNotificationCounter = document.getElementById('dropdownNotificationCounter');
            
            if (!notificationList || !notificationCounter || !dropdownNotificationCounter) {
                console.error('알림 관련 요소를 찾을 수 없습니다.');
                return;
            }
            
            // 알림 카운터 업데이트
            const count = lowStockItems.length;
            notificationCounter.textContent = count;
            dropdownNotificationCounter.textContent = count;
            
            // 알림 목록 비우기
            notificationList.innerHTML = '';
            
            // 알림이 없을 경우 메시지 표시
            if (count === 0) {
                notificationList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-6">알림이 없습니다</div>';
                return;
            }
            
            // 알림 항목 생성
            lowStockItems.forEach(item => {
                const currentStock = parseInt(item.currentStock || 0);
                const minStock = parseInt(item.minStock || 0);
                const diff = minStock - currentStock; // 필요 수량
                
                const notificationItem = document.createElement('div');
                notificationItem.className = 'py-2 px-4 border-b border-gray-200 hover:bg-gray-50 dark:border-gray-700 dark:hover:bg-gray-700';
                
                notificationItem.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0 rounded-full bg-red-200 dark:bg-red-900 p-1">
                            <i class="fas fa-exclamation-circle text-red-600 dark:text-red-400"></i>
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-sm font-medium text-gray-900 dark:text-gray-200">${item.name} 입고 필요</p>
                            <p class="text-xs text-red-500 dark:text-red-400">현재재고: ${currentStock} / 최소재고: ${minStock}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${diff}개 부족</p>
                        </div>
                    </div>
                `;
                
                notificationList.appendChild(notificationItem);
            });
        }

        // 실시간 알림 영역 업데이트 함수 수정
        async function updateAlerts() {
            try {
                // 데이터 가져오기
                const result = await window.partsAPI.getExcelData();
                if (!result.success) {
                    console.error('데이터 로드 실패:', result.error);
                    return;
                }
                
                // 상태가 '필요'인 항목만 필터링
                // 현재 재고가 최소 재고보다 적은 경우 '필요' 상태로 간주
                const lowStockItems = result.data.filter(item => {
                    const currentStock = parseInt(item.currentStock || 0);
                    const minStock = parseInt(item.minStock || 0);
                    return currentStock < minStock;
                });
                
                // 필요한 수량이 많은 순으로 정렬
                lowStockItems.sort((a, b) => {
                    const diffA = parseInt(a.minStock || 0) - parseInt(a.currentStock || 0);
                    const diffB = parseInt(b.minStock || 0) - parseInt(b.currentStock || 0);
                    return diffB - diffA; // 내림차순 정렬
                });
                
                // 최대 3개 제한 제거 - 모든 항목 표시
                const alertsToShow = lowStockItems;
                
                // 알림 컨테이너
                const alertsContainer = document.querySelector('.bg-orange-50.rounded-lg.shadow.p-6.dark\\:bg-orange-100 .space-y-4');
                if (!alertsContainer) {
                    console.error('알림 컨테이너를 찾을 수 없습니다.');
                    return;
                }
                
                // 컨테이너에 고정 높이와 스크롤 속성 추가
                alertsContainer.classList.add('max-h-56', 'overflow-y-auto', 'pr-2');
                alertsContainer.style.scrollbarWidth = 'thin'; // Firefox
                alertsContainer.style.scrollbarColor = 'rgba(180, 180, 180, 0.5) transparent'; // Firefox
                
                // Webkit 브라우저(Chrome, Safari 등)용 스크롤바 스타일
                const style = document.createElement('style');
                style.textContent = `
                    .space-y-4::-webkit-scrollbar {
                        width: 5px;
                    }
                    .space-y-4::-webkit-scrollbar-track {
                        background: transparent;
                    }
                    .space-y-4::-webkit-scrollbar-thumb {
                        background-color: rgba(180, 180, 180, 0.5);
                        border-radius: 20px;
                    }
                    .dark .space-y-4::-webkit-scrollbar-thumb {
                        background-color: rgba(100, 100, 100, 0.5);
                    }
                `;
                document.head.appendChild(style);
                
                // 컨테이너 초기화
                alertsContainer.innerHTML = '';
                
                // 알림 없을 경우 메시지 표시
                if (alertsToShow.length === 0) {
                    const emptyMessage = document.createElement('div');
                    emptyMessage.className = 'text-center text-gray-500 dark:text-gray-400 py-4';
                    emptyMessage.textContent = '재고 알림이 없습니다.';
                    alertsContainer.appendChild(emptyMessage);
                } else {
                    // 각 알림 항목 생성
                    alertsToShow.forEach(item => {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'flex items-start mb-4'; // 마진 추가
                        
                        // 아이콘 부분
                        const iconDiv = document.createElement('div');
                        iconDiv.className = 'flex-shrink-0 w-8 h-8 rounded-full bg-red-200 dark:bg-red-900 flex items-center justify-center';
                        iconDiv.innerHTML = '<i class="fas fa-exclamation-circle text-red-600 dark:text-red-400"></i>';
                        
                        // 컨텐츠 부분
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'ml-3 flex-1'; // flex-1 추가하여 너비 확보
                        
                        // 현재 재고와 최소 재고 계산
                        const currentStock = parseInt(item.currentStock || 0);
                        const minStock = parseInt(item.minStock || 0);
                        const diff = minStock - currentStock; // 필요 수량
                        
                        // 마지막 이벤트 결정 (현재는 입고일만 사용)
                        // 추후 입출고 이력이 추가되면 실제 마지막 이벤트 날짜로 변경 가능
                        const lastEventDate = item.inDate || '정보 없음';
                        const eventType = '입고'; // 현재는 입고일만 있으므로 고정값
                        
                        // 타이틀 생성 - 품명과 필요 상태
                        const title = document.createElement('p');
                        title.className = 'text-sm font-medium';
                        title.textContent = `${item.name} 입고 필요`;
                        
                        // 설명 생성 - 최소재고와 현재재고
                        const description = document.createElement('p');
                        description.className = 'text-xs text-red-500 dark:text-red-400';
                        description.textContent = `최소재고: ${minStock} / 현재재고: ${currentStock} (${diff}개 필요)`;
                        
                        // 날짜 생성 - 마지막 이벤트 날짜
                        const date = document.createElement('p');
                        date.className = 'text-xs text-gray-500 dark:text-gray-400';
                        date.textContent = `마지막 ${eventType}: ${lastEventDate}`;
                        
                        // 컨텐츠에 요소 추가
                        contentDiv.appendChild(title);
                        contentDiv.appendChild(description);
                        contentDiv.appendChild(date);
                        
                        // 모든 요소 조합
                        alertDiv.appendChild(iconDiv);
                        alertDiv.appendChild(contentDiv);
                        
                        // 알림 추가
                        alertsContainer.appendChild(alertDiv);
                    });
                }
                
                // 알림 드롭다운 업데이트
                updateNotificationDropdown(lowStockItems);
                
            } catch (error) {
                console.error('알림 업데이트 중 오류 발생:', error);
            }
        }

        // 메신저 기능 초기화
        function setupMessenger() {
            const messengerButton = document.getElementById('messengerButton');
            const chatModal = document.getElementById('chatModal');
            const minimizeChatButton = document.getElementById('minimizeChatButton');
            const closeChatButton = document.getElementById('closeChatButton');
            const chatInput = document.getElementById('chatInput');
            const sendMessageButton = document.getElementById('sendMessageButton');
            const chatMessages = document.getElementById('chatMessages');
            const messageCounter = document.getElementById('messageCounter');
            
            // 초기 메시지 카운터 설정
            messageCounter.textContent = "0";
            
            // 새 메시지 도착 시뮬레이션 (주기적으로 메시지 카운터 증가)
            let messageSimulationInterval;
            
            function startMessageSimulation() {
                // 이미 실행 중인 경우 중지
                if (messageSimulationInterval) {
                    clearInterval(messageSimulationInterval);
                }
                
                // 15-30초마다 랜덤하게 메시지 카운터 증가
                messageSimulationInterval = setInterval(() => {
                    if (chatModal.classList.contains('hidden')) {
                        const currentCount = parseInt(messageCounter.textContent);
                        messageCounter.textContent = currentCount + 1;
                    }
                }, Math.random() * 15000 + 15000);
            }
            
            // 메시지 시뮬레이션 시작
            startMessageSimulation();
            
            // 메신저 버튼 클릭 이벤트
            if (messengerButton) {
                messengerButton.addEventListener('click', () => {
                    chatModal.classList.remove('hidden');
                    // 메시지 카운터 초기화
                    messageCounter.textContent = "0";
                    
                    // 채팅창 내용 최하단으로 스크롤
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }
            
            // 채팅창 최소화 버튼
            if (minimizeChatButton) {
                minimizeChatButton.addEventListener('click', () => {
                    chatModal.classList.add('hidden');
                });
            }
            
            // 채팅창 닫기 버튼
            if (closeChatButton) {
                closeChatButton.addEventListener('click', () => {
                    chatModal.classList.add('hidden');
                });
            }
            
            // 메시지 전송 함수
            function sendMessage() {
                const messageText = chatInput.value.trim();
                if (messageText === '') return;
                
                // 사용자 메시지 추가
                const userMessageHTML = `
                    <div class="flex flex-col space-y-1">
                        <div class="flex items-end justify-end">
                            <div class="flex flex-col space-y-2 text-xs max-w-xs mx-2 order-1 items-end">
                                <div><span class="px-4 py-2 rounded-lg inline-block rounded-br-none bg-orange-500 text-white dark:bg-orange-600">${messageText}</span></div>
                            </div>
                            <img src="https://via.placeholder.com/30" alt="사용자" class="w-6 h-6 rounded-full order-2">
                        </div>
                    </div>
                `;
                
                chatMessages.innerHTML += userMessageHTML;
                chatInput.value = '';
                
                // 엑셀에 메시지 저장
                saveChatToExcel(messageText);
                
                // 채팅창 내용 최하단으로 스크롤
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // 간단한 응답 메시지 - 메시지가 기록되었음을 알림
                setTimeout(() => {
                    const responseHTML = `
                        <div class="flex flex-col space-y-1">
                            <div class="flex items-end">
                                <div class="flex flex-col space-y-2 text-xs max-w-xs mx-2 order-2 items-start">
                                    <div><span class="px-4 py-2 rounded-lg inline-block rounded-bl-none bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-200">메시지가 기록되었습니다.</span></div>
                                </div>
                                <img src="https://via.placeholder.com/30" alt="시스템" class="w-6 h-6 rounded-full order-1">
                            </div>
                        </div>
                    `;
                    
                    chatMessages.innerHTML += responseHTML;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 500);
            }
            
            // 채팅 내용을 엑셀 파일에 저장하는 함수
            async function saveChatToExcel(message) {
                try {
                    // 현재 날짜와 시간 생성
                    const now = new Date();
                    const dateTimeString = now.toLocaleString(); // 현지 형식의 날짜와 시간
                    
                    // IP 주소 가져오기 
                    let ipAddress = "알 수 없음";
                    try {
                        // IP 주소 가져오기 (Electron 환경에서)
                        const ipResult = await window.partsAPI.getClientIP();
                        if (ipResult.success) {
                            ipAddress = ipResult.data;
                        }
                    } catch (error) {
                        console.warn('IP 주소를 가져오는데 실패했습니다:', error);
                    }
                    
                    console.log('엑셀에 저장할 메시지 데이터:', {
                        message,
                        dateTime: dateTimeString,
                        ipAddress
                    });
                    
                    // 메시지, 날짜/시간, IP 주소를 엑셀에 저장
                    const result = await window.partsAPI.saveChatMessage({
                        message: message,
                        dateTime: dateTimeString,
                        ipAddress: ipAddress
                    });
                    
                    console.log('채팅 메시지 저장 결과:', result);
                    
                    if (!result.success) {
                        console.error('채팅 메시지 저장 실패:', result.error);
                    }
                } catch (error) {
                    console.error('채팅 메시지 저장 중 오류 발생:', error);
                }
            }
            
            // 메시지 전송 버튼 클릭 이벤트
            if (sendMessageButton) {
                sendMessageButton.addEventListener('click', sendMessage);
            }
            
            // 엔터키 입력 이벤트
            if (chatInput) {
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        }        // Board별 부품 사용량 차트 초기화 및 설정
        const integratedChart = echarts.init(document.getElementById('integratedChart'));

        // Board별 부품 사용량 차트 데이터 생성 및 업데이트 함수
        async function updateBoardUsageChart(filteredData = null) {
            try {
                let historyData;
                
                if (filteredData) {
                    historyData = filteredData;
                } else {
                    // 입출고 내역 데이터 가져오기
                    const result = await window.partsAPI.getHistoryData();
                    if (!result.success) {
                        console.error('입출고 내역 데이터 로드 실패:', result.error);
                        
                        // 오류 상태 차트 표시
                        integratedChart.setOption({
                            title: {
                                text: '데이터를 불러올 수 없습니다',
                                left: 'center',
                                textStyle: {
                                    fontSize: 16,
                                    color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#ff4757'
                                }
                            },
                            series: []
                        });
                        return;
                    }
                    historyData = result.data || [];
                }
                
                // 날짜 필터 적용
                historyData = filterDataByDate(historyData, 'date');
                
                console.log('Board별 부품 사용량 분석 시작, 날짜 필터 적용 후 데이터:', historyData);
                
                // 출고 데이터만 필터링 (Board별 사용량이므로 출고 데이터 사용)
                const exportData = historyData.filter(item => 
                    item.type === '출고' && item.name && item.amount
                );
                
                console.log('출고 데이터:', exportData);
                
                // 품명별 사용량 집계
                const categorySummary = {};

                exportData.forEach(item => {
                    const categoryName = item.category || '기타'; // 카테고리로 변경
                    
                    // 다양한 필드명으로 수량 시도
                    let quantity = 0;
                    const possibleFields = ['quantity', 'count', 'amount', 'stock', 'value'];

                    // 여러 필드명 시도
                    for (const field of possibleFields) {
                        if (item[field] !== undefined && item[field] !== null) {
                            const rawValue = item[field];
                            
                            // 숫자 변환 시도
                            if (!isNaN(Number(rawValue))) {
                                quantity = Number(rawValue);
                                console.log(`${field} 필드에서 수량 ${quantity} 찾음`);
                                break;
                            } 
                            // 문자열에서 숫자 추출 시도
                            else if (typeof rawValue === 'string') {
                                const matches = rawValue.match(/\d+/);
                                if (matches && matches.length > 0) {
                                    quantity = Number(matches[0]);
                                    console.log(`${field} 필드의 문자열에서 수량 ${quantity} 추출`);
                                    break;
                                }
                            }
                        }
                    }

                    // 수량이 0이면 기본값 1로 설정
                    if (quantity === 0) {
                        quantity = 1;
                        console.log(`카테고리: ${categoryName}의 수량을 찾을 수 없어 기본값 1 사용`);
                    }
                    
                    if (!categorySummary[categoryName]) {
                        categorySummary[categoryName] = 0;
                    }
                    
                    categorySummary[categoryName] += quantity;
                });
                
                // 차트 데이터 변환 (사용량 기준 내림차순 정렬)
                const sortedData = Object.entries(categorySummary)
                    .sort(([,a], [,b]) => b - a); // 모든 품목 표시
                
                const partNames = sortedData.map(([name]) => name);
                const usageData = sortedData.map(([, usage]) => usage);
                
                console.log('차트 데이터 - 품명:', partNames);
                console.log('차트 데이터 - 사용량:', usageData);
                
                // 차트 제목에 필터 정보 포함
                let chartTitle = `🤖 Board별 부품 사용량 분석 (${partNames.length}개 품목)`;
                if (globalDateFilter.startDate || globalDateFilter.endDate) {
                    const startStr = globalDateFilter.startDate ? globalDateFilter.startDate.toLocaleDateString() : '시작';
                    const endStr = globalDateFilter.endDate ? globalDateFilter.endDate.toLocaleDateString() : '종료';
                    chartTitle += ` [${startStr} ~ ${endStr}]`;
                }
                
                // 데이터가 없는 경우 처리
                if (partNames.length === 0) {
                    integratedChart.setOption({
                        title: {
                            text: '선택 기간에 출고 데이터가 없습니다',
                            left: 'center',
                            textStyle: {
                                fontSize: 16,
                                color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#333333'
                            }
                        },
                        series: []
                    });
                    return;
                }
                
                // 3D AI 미래지향적 차트 옵션 설정
                integratedChart.setOption({
                    animation: true,
                    animationDuration: 2000,
                    animationEasing: 'cubicOut',
                    animationDelay: function (idx) {
                        return idx * 150;
                    },
                    backgroundColor: document.documentElement.classList.contains('dark') ? 
                        'transparent' : 'transparent',
                    title: {
                        text: chartTitle,
                        left: 'center',
                        top: '3%',
                        textStyle: {
                            fontSize: 18,
                            fontWeight: 'bold',
                            color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#0066cc',
                            textShadowBlur: 10,
                            textShadowColor: document.documentElement.classList.contains('dark') ? 
                                'rgba(255, 255, 255, 0.5)' : 'rgba(0, 102, 204, 0.3)',
                        }
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow',
                            shadowStyle: {
                                color: 'rgba(0, 212, 255, 0.2)',
                                shadowBlur: 20,
                                shadowOffsetX: 5,
                                shadowOffsetY: 5
                            }
                        },
                        formatter: function(params) {
                            const data = params[0];
                            return `
                                <div style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    border: none;
                                    border-radius: 12px;
                                    padding: 12px;
                                    color: white;
                                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                                    backdrop-filter: blur(10px);
                                ">
                                    <div style="font-weight: bold; margin-bottom: 8px;">
                                        🎯 ${data.name}
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        <span style="margin-right: 8px;">📊</span>
                                        사용량: ${data.value}개
                                    </div>
                                </div>
                            `;
                        },
                        backgroundColor: 'transparent',
                        borderColor: 'transparent',
                        textStyle: {
                            color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#333333'
                        }
                    },
                    grid: {
                        left: '8%',
                        right: '8%',
                        bottom: '15%',
                        top: '20%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: partNames,
                        axisPointer: {
                            type: 'shadow'
                        },
                        axisLabel: {
                            rotate: 45,
                            interval: 0,
                            textStyle: {
                                fontSize: 11,
                                fontWeight: 'bold',
                                color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#0066cc',
                                textShadowBlur: 3,
                                textShadowColor: document.documentElement.classList.contains('dark') ? 
                                    'rgba(255, 255, 255, 0.3)' : 'rgba(0, 102, 204, 0.2)',
                            }
                        },
                        axisLine: {
                            lineStyle: {
                                color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#0066cc',
                                width: 2,
                                shadowBlur: 10,
                                shadowColor: document.documentElement.classList.contains('dark') ? 
                                    'rgba(255, 255, 255, 0.5)' : 'rgba(0, 102, 204, 0.3)',
                            }
                        },
                        axisTick: {
                            lineStyle: {
                                color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#0066cc',
                                width: 2
                            }
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: '🤖 사용량 분석 (개)',
                        nameTextStyle: {
                            color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#0066cc',
                            fontSize: 13,
                            fontWeight: 'bold',
                            textShadowBlur: 5,
                            textShadowColor: document.documentElement.classList.contains('dark') ? 
                                'rgba(255, 255, 255, 0.3)' : 'rgba(0, 102, 204, 0.2)',
                        },
                        axisLabel: {
                            formatter: '{value}',
                            textStyle: {
                                color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#0066cc',
                                fontSize: 11,
                                fontWeight: 'bold',
                                textShadowBlur: 3,
                                textShadowColor: document.documentElement.classList.contains('dark') ? 
                                    'rgba(255, 255, 255, 0.3)' : 'rgba(0, 102, 204, 0.2)',
                            }
                        },
                        axisLine: {
                            lineStyle: {
                                color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#0066cc',
                                width: 2,
                                shadowBlur: 10,
                                shadowColor: document.documentElement.classList.contains('dark') ? 
                                    'rgba(255, 255, 255, 0.5)' : 'rgba(0, 102, 204, 0.3)',
                            }
                        },
                        splitLine: {
                            lineStyle: {
                                color: document.documentElement.classList.contains('dark') ? 
                                    'rgba(255, 255, 255, 0.1)' : 'rgba(0, 102, 204, 0.1)',
                                width: 1,
                                type: 'dashed'
                            }
                        }
                    },
                    series: [
                        {
                            name: '🤖 부품 사용량 분석',
                            type: 'bar',
                            data: usageData.map((value, index) => ({
                                value: value,
                                itemStyle: {
                                    // 3D 그라데이션 색상 배열
                                    color: function() {
                                        const futuristicColors = [
                                            // 네온 사이버 그라데이션
                                            {
                                                type: 'linear',
                                                x: 0, y: 0, x2: 0, y2: 1,
                                                colorStops: [
                                                    {offset: 0, color: '#ff006e'},
                                                    {offset: 0.5, color: '#8338ec'},
                                                    {offset: 1, color: '#3a86ff'}
                                                ]
                                            },
                                            // 홀로그램 그라데이션
                                            {
                                                type: 'linear',
                                                x: 0, y: 0, x2: 0, y2: 1,
                                                colorStops: [
                                                    {offset: 0, color: '#00f5ff'},
                                                    {offset: 0.5, color: '#00d4ff'},
                                                    {offset: 1, color: '#0066cc'}
                                                ]
                                            },
                                            // AI 그린 그라데이션
                                            {
                                                type: 'linear',
                                                x: 0, y: 0, x2: 0, y2: 1,
                                                colorStops: [
                                                    {offset: 0, color: '#39ff14'},
                                                    {offset: 0.5, color: '#00ff88'},
                                                    {offset: 1, color: '#00cc66'}
                                                ]
                                            },
                                            // 퓨처 오렌지 그라데이션
                                            {
                                                type: 'linear',
                                                x: 0, y: 0, x2: 0, y2: 1,
                                                colorStops: [
                                                    {offset: 0, color: '#ff9500'},
                                                    {offset: 0.5, color: '#ff6b35'},
                                                    {offset: 1, color: '#e65100'}
                                                ]
                                            },
                                            // 네온 퍼플 그라데이션
                                            {
                                                type: 'linear',
                                                x: 0, y: 0, x2: 0, y2: 1,
                                                colorStops: [
                                                    {offset: 0, color: '#d946ef'},
                                                    {offset: 0.5, color: '#a855f7'},
                                                    {offset: 1, color: '#7c3aed'}
                                                ]
                                            },
                                            // 사이버 옐로우 그라데이션
                                            {
                                                type: 'linear',
                                                x: 0, y: 0, x2: 0, y2: 1,
                                                colorStops: [
                                                    {offset: 0, color: '#ffd60a'},
                                                    {offset: 0.5, color: '#ffbe0b'},
                                                    {offset: 1, color: '#fb8500'}
                                                ]
                                            }
                                        ];
                                        return futuristicColors[index % futuristicColors.length];
                                    }(),
                                    borderRadius: [8, 8, 0, 0],
                                    // 3D 효과를 위한 강력한 그림자
                                    shadowBlur: 25,
                                    shadowColor: 'rgba(0, 212, 255, 0.6)',
                                    shadowOffsetX: 8,
                                    shadowOffsetY: 12,
                                    // 네온 발광 효과
                                    borderColor: document.documentElement.classList.contains('dark') ? '#00d4ff' : '#0066cc',
                                    borderWidth: 2,
                                    // 3D 깊이감을 위한 opacity 변화
                                    opacity: 0.9
                                }
                            })),
                            emphasis: {
                                focus: 'series',
                                itemStyle: {
                                    shadowBlur: 40,
                                    shadowOffsetX: 12,
                                    shadowOffsetY: 18,
                                    shadowColor: 'rgba(0, 212, 255, 0.8)',
                                    borderWidth: 3,
                                    borderColor: '#ffffff',
                                    opacity: 1,
                                    // 호버 시 스케일 업 효과
                                    scale: 1.05
                                },
                                // 3D 변형 효과
                                scaleSize: 8
                            },
                            barMaxWidth: 60,
                            // 막대 간격 조정으로 3D 효과 강화
                            barGap: '20%',
                            // 막대 모서리를 둥글게 처리
                            barBorderRadius: [8, 8, 0, 0],
                            // 애니메이션 효과 추가
                            animationDuration: 2000,
                            animationEasing: 'elasticOut',
                            animationDelay: function (idx) {
                                return idx * 200;
                            },
                            // 3D 라벨 효과
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '🚀 {c}',
                                textStyle: {
                                    color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#0066cc',
                                    fontSize: 12,
                                    fontWeight: 'bold',
                                    textShadowBlur: 8,
                                    textShadowColor: document.documentElement.classList.contains('dark') ? 
                                        'rgba(255, 255, 255, 0.8)' : 'rgba(0, 102, 204, 0.6)',
                                    textShadowOffsetX: 2,
                                    textShadowOffsetY: 2
                                }
                            },
                            // 3D 발광 효과를 위한 markLine 추가
                            markLine: {
                                silent: true,
                                lineStyle: {
                                    color: document.documentElement.classList.contains('dark') ? 
                                        'rgba(255, 255, 255, 0.3)' : 'rgba(0, 102, 204, 0.2)',
                                    width: 1,
                                    type: 'dashed'
                                },
                                data: [
                                    {type: 'average', name: 'AI 평균값'}
                                ]
                            }
                        }
                    ],
                    // 3D 효과를 위한 추가 옵션
                    graphic: [
                        {
                            type: 'group',
                            left: 'center',
                            top: '5%',
                            children: [
                                {
                                    type: 'rect',
                                    z: 100,
                                    left: 'center',
                                    top: 'middle',
                                    shape: {
                                        width: 0,
                                        height: 0
                                    },
                                    style: {
                                        fill: 'transparent'
                                    }
                                }
                            ]
                        }
                    ]
                });
                
                console.log('3D AI Board별 부품 사용량 차트 업데이트 완료');
                
            } catch (error) {
                console.error('Board별 부품 사용량 차트 업데이트 중 오류:', error);
                
                // 오류 차트 표시
                integratedChart.setOption({
                    title: {
                        text: '🤖 AI 차트 업데이트 중 오류가 발생했습니다',
                        left: 'center',
                        textStyle: {
                            fontSize: 16,
                            color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#ff4757'
                        }
                    },
                    series: []
                });
            }
        }

        // 날짜 범위 필터와 관련된 전역 변수
        let globalDateFilter = {
            startDate: null,
            endDate: null
        };

        // 날짜 범위 필터 초기화
        async function setupDateFilter() {
            const startDateFilter = document.getElementById('startDateFilter');
            const endDateFilter = document.getElementById('endDateFilter');
            const applyDateFilter = document.getElementById('applyDateFilter');
            const resetDateFilter = document.getElementById('resetDateFilter');

            // 현재 날짜로 기본값 설정 (최근 1개월)
            const today = new Date();
            const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());

            endDateFilter.value = today.toISOString().split('T')[0];
            startDateFilter.value = oneMonthAgo.toISOString().split('T')[0];

            // 초기 필터 값 설정
            globalDateFilter.startDate = oneMonthAgo;
            globalDateFilter.endDate = today;

            console.log('날짜 필터 초기값 설정 및 적용:', globalDateFilter);

            // 디폴트 필터 적용 (자동으로 적용 버튼이 눌린 것처럼 차트 업데이트)
            await updateBoardUsageChart();

            // 필터 적용 버튼 이벤트
            if (applyDateFilter) {
                applyDateFilter.addEventListener('click', async () => {
                    const startDate = startDateFilter.value ? new Date(startDateFilter.value) : null;
                    const endDate = endDateFilter.value ? new Date(endDateFilter.value) : null;

                    // 날짜 유효성 검사
                    if (startDate && endDate && startDate > endDate) {
                        alert('시작 날짜는 종료 날짜보다 이전이어야 합니다.');
                        return;
                    }

                    // 전역 필터 값 업데이트
                    globalDateFilter.startDate = startDate;
                    globalDateFilter.endDate = endDate;

                    console.log('날짜 필터 적용:', globalDateFilter);

                    // Board별 부품 사용량 차트만 업데이트
                    await updateBoardUsageChart();
                });
            }

            // 필터 초기화 버튼 이벤트
            if (resetDateFilter) {
                resetDateFilter.addEventListener('click', async () => {
                    startDateFilter.value = '';
                    endDateFilter.value = '';
                    globalDateFilter.startDate = null;
                    globalDateFilter.endDate = null;

                    console.log('날짜 필터 초기화');

                    // Board별 부품 사용량 차트만 업데이트 (필터 없이)
                    await updateBoardUsageChart();
                });
            }
        }

        // 날짜 필터링 함수
        function filterDataByDate(data, dateField = 'date') {
            if (!globalDateFilter.startDate && !globalDateFilter.endDate) {
                return data; // 필터가 설정되지 않았으면 전체 데이터 반환
            }

            return data.filter(item => {
                if (!item[dateField]) return true; // 날짜 정보가 없으면 포함

                try {
                    const itemDate = new Date(item[dateField]);
                    if (isNaN(itemDate.getTime())) return true; // 유효하지 않은 날짜면 포함

                    // 시작 날짜 체크
                    if (globalDateFilter.startDate && itemDate < globalDateFilter.startDate) {
                        return false;
                    }

                    // 종료 날짜 체크 (종료 날짜 당일 23:59:59까지 포함)
                    if (globalDateFilter.endDate) {
                        const endOfDay = new Date(globalDateFilter.endDate);
                        endOfDay.setHours(23, 59, 59, 999);
                        if (itemDate > endOfDay) {
                            return false;
                        }
                    }

                    return true;
                } catch (error) {
                    console.warn('날짜 필터링 중 오류:', error, item);
                    return true; // 오류 발생 시 포함
                }
            });
        }

        // 모든 차트를 날짜 필터와 함께 업데이트하는 함수
        async function updateAllChartsWithDateFilter() {
            try {
                console.log('날짜 필터를 적용하여 모든 차트 업데이트 시작');
                
                // 로딩 표시 (선택사항)
                const loadingMessage = document.createElement('div');
                loadingMessage.id = 'chartLoadingMessage';
                loadingMessage.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-orange-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                loadingMessage.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>차트 업데이트 중...';
                document.body.appendChild(loadingMessage);

                // 1. 년도.월별 출고 현황 차트 업데이트 (날짜 필터 무시)
                await updateStockChart();

                // 2. 카테고리별 구매금액 차트는 날짜 필터 무시 (년도 필터만 사용)
                // updateFlowChart는 년도 필터에서만 호출됨

                // 3. Board별 부품 사용량 차트 업데이트 (날짜 필터 적용)
                await updateBoardUsageChart();
                
                // 4. 실시간 알림 업데이트
                await updateAlerts();

                // 로딩 메시지 제거
                const loading = document.getElementById('chartLoadingMessage');
                if (loading) {
                    loading.remove();
                }

                console.log('모든 차트 업데이트 완료');
                
                // 성공 메시지 표시 (3초 후 자동 제거)
                const successMessage = document.createElement('div');
                successMessage.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                successMessage.innerHTML = '<i class="fas fa-check mr-2"></i>차트가 업데이트되었습니다.';
                document.body.appendChild(successMessage);
                
                setTimeout(() => {
                    if (successMessage.parentNode) {
                        successMessage.remove();
                    }
                }, 3000);

            } catch (error) {
                console.error('차트 업데이트 중 오류 발생:', error);
                
                // 로딩 메시지 제거
                const loading = document.getElementById('chartLoadingMessage');
                if (loading) {
                    loading.remove();
                }
                
                // 오류 메시지 표시
                const errorMessage = document.createElement('div');
                errorMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                errorMessage.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>차트 업데이트 중 오류가 발생했습니다.';
                document.body.appendChild(errorMessage);
                
                setTimeout(() => {
                    if (errorMessage.parentNode) {
                        errorMessage.remove();
                    }
                }, 5000);
            }
        }

        // 년도.월별 출고 현황 차트 업데이트 함수 (날짜 필터 무시)
        async function updateStockChart() {
            try {
                const stockChart = echarts.init(document.getElementById('stockChart'));
                
                // 1. 입출고 내역 데이터 가져오기 (날짜 필터 적용하지 않음)
                const result = await window.partsAPI.getHistoryData();
                if (!result.success) {
                    console.error('입출고 내역 데이터를 가져오는데 실패했습니다:', result.error);
                    stockChart.setOption({
                        series: [{
                            data: [
                                { value: 1, name: '데이터 없음' }
                            ]
                        }]
                    });
                    return;
                }
                
                console.log('월별 출고 현황 - 전체 데이터:', result.data);
                
                // 날짜 필터 적용하지 않고 전체 데이터 사용
                let allData = result.data || [];
                
                // 2. 출고 데이터만 필터링
                const outflowData = allData.filter(item => {
                    const type = (item.type || '').toLowerCase();
                    return type === '출고' || type === 'out' || type === 'outflow';
                });
                
                console.log('월별 출고 현황 - 출고 데이터:', outflowData);
                
                // 3. 년도.월별로 출고 수량 집계
                const monthlyOutflow = {};

                outflowData.forEach(item => {
                    if (!item.date) return; // 날짜 정보가 없으면 스킵
                    
                    try {
                        const itemDate = new Date(item.date);
                        if (isNaN(itemDate.getTime())) return; // 유효하지 않은 날짜면 스킵
                        
                        // YYYY.MM 형식으로 변환
                        const yearMonth = `${itemDate.getFullYear()}.${String(itemDate.getMonth() + 1).padStart(2, '0')}`;
                        
                        // 다양한 필드명으로 수량 시도
                        let quantity = 0;
                        const possibleFields = ['quantity', 'count', 'amount', 'stock', 'value'];

                        for (const field of possibleFields) {
                            if (item[field] !== undefined && item[field] !== null) {
                                const rawValue = item[field];
                                
                                if (!isNaN(Number(rawValue))) {
                                    quantity = Number(rawValue);
                                    break;
                                } else if (typeof rawValue === 'string') {
                                    const matches = rawValue.match(/\d+/);
                                    if (matches && matches.length > 0) {
                                        quantity = Number(matches[0]);
                                        break;
                                    }
                                }
                            }
                        }

                        // 수량이 0이면 기본값 1로 설정
                        if (quantity === 0) {
                            quantity = 1;
                        }
                        
                        if (!monthlyOutflow[yearMonth]) {
                            monthlyOutflow[yearMonth] = 0;
                        }
                        
                        monthlyOutflow[yearMonth] += quantity;
                        
                    } catch (error) {
                        console.warn('날짜 처리 중 오류:', error, item);
                    }
                });
                
                // 4. 데이터가 없는 경우 테스트 데이터 생성
                if (Object.keys(monthlyOutflow).length === 0) {
                    console.log('실제 월별 출고 데이터가 없어 테스트 데이터를 사용합니다.');
                    const currentDate = new Date();
                    for (let i = 5; i >= 0; i--) {
                        const testDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                        const yearMonth = `${testDate.getFullYear()}.${String(testDate.getMonth() + 1).padStart(2, '0')}`;
                        monthlyOutflow[yearMonth] = Math.floor(Math.random() * 50) + 10; // 10-60 사이 랜덤값
                    }
                }
                
                // 5. 월별 데이터를 시간순으로 정렬 (최근 12개월만 표시)
                const sortedMonths = Object.keys(monthlyOutflow)
                    .sort((a, b) => a.localeCompare(b))
                    .slice(-12); // 최근 12개월만
                
                const categories = sortedMonths;
                const values = sortedMonths.map(month => monthlyOutflow[month]);
                
                // 퍼센테이지 계산을 위한 총합
                const totalValue = values.reduce((sum, value) => sum + value, 0);
                const percentages = values.map(value => 
                    totalValue > 0 ? ((value / totalValue) * 100).toFixed(1) : 0
                );
                
                console.log('월별 출고 현황 - 최종 데이터:', { categories, values, percentages });
                
                // 6. 차트 제목 (날짜 필터 정보 제외)
                const chartTitle = '연도&월별 출고 현황 (전체 기간)';
                
                // 7. 가로 막대 차트 설정 (단색 평면 스타일)
                stockChart.setOption({
                    backgroundColor: 'transparent',
                    title: {
                        text: chartTitle,
                        left: 'center',
                        textStyle: {
                            fontSize: 14,
                            fontWeight: 'bold',
                            color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#92400e'
                        }
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        },
                        formatter: function(params) {
                            const data = params[0];
                            const index = data.dataIndex;
                            const value = values[index];
                            const percentage = percentages[index];
                            return `${data.name}<br/>출고량: ${value}개<br/>비율: ${percentage}%`;
                        }
                    },
                    grid: {
                        left: '20%',
                        right: '10%',
                        top: '20%',
                        bottom: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'value',
                        max: Math.max(...percentages) * 1.1,
                        axisLabel: {
                            formatter: '{value}%',
                            color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#78350f'
                        },
                        axisLine: {
                            lineStyle: {
                                color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#d97706'
                            }
                        },
                        splitLine: {
                            lineStyle: {
                                color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.2)' : '#fed7aa',
                                type: 'dashed'
                            }
                        }
                    },
                    yAxis: {
                        type: 'category',
                        data: categories,
                        axisLabel: {
                            color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#78350f',
                            fontSize: 11
                        },
                        axisLine: {
                            lineStyle: {
                                color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#d97706'
                            }
                        },
                        axisTick: {
                            show: false
                        }
                    },
                    series: [{
                        name: '월별 출고량',
                        type: 'bar',
                        data: percentages.map((percentage, index) => {
                            // 랜덤 색상 배열
                            const colors = [
                                '#f97316', '#ef4444', '#3b82f6', '#10b981', '#8b5cf6',
                                '#ec4899', '#14b8a6', '#f59e0b', '#6366f1', '#84cc16',
                                '#06b6d4', '#f43f5e', '#8b5cf6', '#22c55e', '#eab308'
                            ];
                            return {
                                value: percentage,
                                itemStyle: {
                                    color: colors[index % colors.length],
                                    borderRadius: [0, 4, 4, 0]
                                }
                            };
                        }),
                        label: {
                            show: true,
                            position: 'right',
                            formatter: function(params) {
                                const index = params.dataIndex;
                                const value = values[index];
                                return `${value}개 (${params.value}%)`;
                            },
                            color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#78350f',
                            fontSize: 10
                        },
                        emphasis: {
                            itemStyle: {
                                opacity: 0.8
                            }
                        },
                        barMaxWidth: 25
                    }]
                });
                
                // 차트 클릭 이벤트 추가 - 월별 막대를 클릭하면 해당 월의 카테고리별 분포 모달 표시
                stockChart.off('click'); // 기존 이벤트 제거
                stockChart.on('click', function(params) {
                    if (params.componentType === 'series') {
                        const clickedMonth = categories[params.dataIndex];
                        console.log('클릭된 월:', clickedMonth);
                        showCategoryModal(clickedMonth, allData);
                    }
                });
                
                console.log('년도.월별 출고 현황 차트가 업데이트되었습니다.');
                
            } catch (error) {
                console.error('월별 출고 현황 차트 업데이트 중 오류 발생:', error);
                const stockChart = echarts.init(document.getElementById('stockChart'));
                stockChart.setOption({
                    title: {
                        text: '차트 업데이트 중 오류가 발생했습니다',
                        left: 'center',
                        textStyle: {
                            fontSize: 14,
                            color: '#ff4757'
                        }
                    },
                    series: []
                });
            }
        }

        // 카테고리별 구매금액 차트 업데이트 함수 (년도 필터만 적용, 날짜 필터 무시)
        async function updateFlowChart(selectedYear = 'all') {
            try {
                const flowChart = echarts.init(document.getElementById('flowChart'));

                // 1. 입출고 내역 데이터 가져오기 (날짜 필터 무시)
                const result = await window.partsAPI.getHistoryData();
                if (!result.success) {
                    console.error('입출고 내역 데이터를 가져오는데 실패했습니다:', result.error);
                    flowChart.setOption({
                        animation: false,
                        title: {
                            text: '구매금액 합계',
                            left: 'center',
                            textStyle: {
                                fontSize: 14,
                                color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#333333'
                            }
                        },
                        series: [{
                            type: 'pie',
                            radius: ['30%', '60%'],
                            center: ['50%', '45%'],
                            data: [{ value: 0, name: '데이터 없음' }]
                        }]
                    });
                    // 총 구매 비용도 0으로 설정
                    document.getElementById('totalPurchaseCost').textContent = '₩0';
                    return;
                }

                console.log('입출고 내역 데이터:', result.data);

                // 날짜 필터 적용하지 않음 - 전체 데이터 사용
                let filteredData = result.data || [];

                // 년도 필터 적용 (선택된 경우에만)
                if (selectedYear !== 'all') {
                    filteredData = filteredData.filter(item => {
                        if (!item.date) return false;
                        const itemDate = new Date(item.date);
                        return itemDate.getFullYear() === parseInt(selectedYear);
                    });
                }

                // 2. 카테고리별 구매금액 집계
                const categoryAmounts = {};
                let totalCost = 0;

                if (filteredData && filteredData.length > 0) {
                    filteredData.forEach(item => {
                        if (item.category && item.purchasePrice && !isNaN(item.purchasePrice)) {
                            const category = item.category;
                            const amount = parseFloat(item.purchasePrice) || 0;

                            totalCost += amount;

                            if (categoryAmounts[category]) {
                                categoryAmounts[category] += amount;
                            } else {
                                categoryAmounts[category] = amount;
                            }
                        }
                    });
                }

                // 총 구매 비용 표시
                const totalCostElement = document.getElementById('totalPurchaseCost');
                const totalCostLabel = document.getElementById('totalCostLabel');
                const isDark = document.documentElement.classList.contains('dark');

                totalCostElement.textContent = `₩${totalCost.toLocaleString()}`;

                // 텍스트 색상 설정
                if (isDark) {
                    totalCostLabel.style.color = '#ffffff';
                    totalCostElement.style.color = '#fb923c'; // orange-400
                } else {
                    totalCostLabel.style.color = '#000000';
                    totalCostElement.style.color = '#ea580c'; // orange-600
                }

                // 3. 차트 데이터 변환
                const chartData = Object.entries(categoryAmounts).map(([category, amount]) => ({
                    name: category,
                    value: amount
                }));

                // 4. 데이터가 없는 경우 처리
                if (chartData.length === 0) {
                    chartData.push({ value: 0, name: '선택 기간 구매 내역 없음' });
                    document.getElementById('totalPurchaseCost').textContent = '₩0';
                }

                console.log('카테고리별 구매금액 차트 데이터:', chartData);

                // 5. 차트 제목 (년도 필터 정보 포함)
                let chartTitle = '카테고리별 구매금액';
                if (selectedYear !== 'all') {
                    chartTitle += ` (${selectedYear})`;
                }
                
                // 원형 차트 옵션 설정
                flowChart.setOption({
                    animation: true,
                    animationDuration: 1500,
                    animationEasing: 'elasticOut',
                    animationDelay: function (idx) {
                        return idx * 200;
                    },
                    title: {
                        text: chartTitle,
                        left: 'center',
                        top: 10,
                        textStyle: {
                            fontSize: 14,
                            color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#333333'
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            if (params.value === 0) {
                                return params.name;
                            }
                            return `${params.name}<br/>구매금액: ₩${params.value.toLocaleString()}<br/>비율: ${params.percent}%`;
                        },
                        backgroundColor: document.documentElement.classList.contains('dark') ? 'rgba(30, 30, 30, 0.9)' : 'rgba(255, 255, 255, 0.9)',
                        textStyle: {
                            color: document.documentElement.classList.contains('dark') ? '#fff' : '#333'
                        }
                    },
                    legend: {
                        orient: 'horizontal',
                        bottom: 10,
                        textStyle: {
                            fontSize: 12,
                            color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#333333'  // 다크모드에 따라 조건부 색상
                        },
                        inactiveColor: document.documentElement.classList.contains('dark') ? '#666666' : '#cccccc'  // 다크모드에 따라 조건부 비활성 색상
                    },
                    series: [{
                        type: 'pie',
                        radius: ['30%', '60%'],
                        center: ['50%', '45%'],
                        data: chartData,
                        itemStyle: {
                            borderRadius: 15,
                            borderColor: document.documentElement.classList.contains('dark') ? '#2d2d2d' : '#fff',
                            borderWidth: 3,
                            // 3D 효과를 위한 그림자 추가
                            shadowBlur: 15,
                            shadowColor: 'rgba(0, 0, 0, 0.3)',
                            shadowOffsetX: 3,
                            shadowOffsetY: 8,
                            // 그라데이션 효과로 3D 느낌 연출
                            color: function(params) {
                                const colors = [
                                    ['#FF9500', '#FF6B35'],
                                    ['#2ECC71', '#27AE60'],
                                    ['#3498DB', '#2980B9'],
                                    ['#9B59B6', '#8E44AD'],
                                    ['#E74C3C', '#C0392B'],
                                    ['#F39C12', '#E67E22'],
                                    ['#1ABC9C', '#16A085'],
                                    ['#34495E', '#2C3E50']
                                ];
                                const colorPair = colors[params.dataIndex % colors.length];
                                return {
                                    type: 'linear',
                                    x: 0, y: 0, x2: 1, y2: 1,
                                    colorStops: [{
                                        offset: 0, color: colorPair[0]
                                    }, {
                                        offset: 1, color: colorPair[1]
                                    }]
                                };
                            }
                        },
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 25,
                                shadowOffsetX: 5,
                                shadowOffsetY: 12,
                                shadowColor: 'rgba(0, 0, 0, 0.4)',
                                scale: true,
                                scaleSize: 10
                            },
                            scale: true,
                            scaleSize: 5
                        },
                        label: {
                            show: false  // 레이블 제거
                        }
                    }]
                });
                
                console.log('카테고리별 구매금액 차트가 업데이트되었습니다.');
                
            } catch (error) {
                console.error('입출고 현황 차트 업데이트 중 오류 발생:', error);
                const flowChart = echarts.init(document.getElementById('flowChart'));
                flowChart.setOption({
                    title: {
                        text: '차트 업데이트 중 오류가 발생했습니다',
                        left: 'center',
                        textStyle: {
                            fontSize: 14,
                            color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#333333'
                        }
                    },
                    series: []
                });
            }
        }

        // Board별 부품 사용량 차트 데이터 생성 및 업데이트 함수 (날짜 필터 적용)
        async function updateBoardUsageChart(filteredData = null) {
            try {
                let historyData;
                
                if (filteredData) {
                    historyData = filteredData;
                } else {
                    // 입출고 내역 데이터 가져오기
                    const result = await window.partsAPI.getHistoryData();
                    if (!result.success) {
                        console.error('입출고 내역 데이터 로드 실패:', result.error);
                        
                        // 오류 상태 차트 표시
                        integratedChart.setOption({
                            title: {
                                text: '데이터를 불러올 수 없습니다',
                                left: 'center',
                                textStyle: {
                                    fontSize: 16,
                                    color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#ff4757'
                                }
                            },
                            series: []
                        });
                        return;
                    }
                    historyData = result.data || [];
                }
                
                // 날짜 필터 적용
                historyData = filterDataByDate(historyData, 'date');
                
                console.log('Board별 부품 사용량 분석 시작, 날짜 필터 적용 후 데이터:', historyData);
                
                // 출고 데이터만 필터링 (Board별 사용량이므로 출고 데이터 사용)
                const exportData = historyData.filter(item => 
                    item.type === '출고' && item.name && item.amount
                );
                
                console.log('출고 데이터:', exportData);
                
                // 품명별 사용량 집계
                const categorySummary = {};

                exportData.forEach(item => {
                    const categoryName = item.category || '기타'; // 카테고리로 변경
                    
                    // 다양한 필드명으로 수량 시도
                    let quantity = 0;
                    const possibleFields = ['quantity', 'count', 'amount', 'stock', 'value'];

                    // 여러 필드명 시도
                    for (const field of possibleFields) {
                        if (item[field] !== undefined && item[field] !== null) {
                            const rawValue = item[field];
                            
                            // 숫자 변환 시도
                            if (!isNaN(Number(rawValue))) {
                                quantity = Number(rawValue);
                                console.log(`${field} 필드에서 수량 ${quantity} 찾음`);
                                break;
                            } 
                            // 문자열에서 숫자 추출 시도
                            else if (typeof rawValue === 'string') {
                                const matches = rawValue.match(/\d+/);
                                if (matches && matches.length > 0) {
                                    quantity = Number(matches[0]);
                                    console.log(`${field} 필드의 문자열에서 수량 ${quantity} 추출`);
                                    break;
                                }
                            }
                        }
                    }

                    // 수량이 0이면 기본값 1로 설정
                    if (quantity === 0) {
                        quantity = 1;
                        console.log(`카테고리: ${categoryName}의 수량을 찾을 수 없어 기본값 1 사용`);
                    }
                    
                    if (!categorySummary[categoryName]) {
                        categorySummary[categoryName] = 0;
                    }
                    
                    categorySummary[categoryName] += quantity;
                });
                
                // 차트 데이터 변환 (사용량 기준 내림차순 정렬)
                const sortedData = Object.entries(categorySummary)
                    .sort(([,a], [,b]) => b - a); // 모든 품목 표시
                
                const partNames = sortedData.map(([name]) => name);
                const usageData = sortedData.map(([, usage]) => usage);
                
                console.log('차트 데이터 - 품명:', partNames);
                console.log('차트 데이터 - 사용량:', usageData);
                
                // 차트 제목에 필터 정보 포함
                let chartTitle = `Board별 부품 사용량 분석 `;
                if (globalDateFilter.startDate || globalDateFilter.endDate) {
                    const startStr = globalDateFilter.startDate ? globalDateFilter.startDate.toLocaleDateString() : '시작';
                    const endStr = globalDateFilter.endDate ? globalDateFilter.endDate.toLocaleDateString() : '종료';
                    chartTitle += ` [${startStr} ~ ${endStr}]`;
                }
                
                // 데이터가 없는 경우 처리
                if (partNames.length === 0) {
                    integratedChart.setOption({
                        title: {
                            text: '선택 기간에 출고 데이터가 없습니다',
                            left: 'center',
                            textStyle: {
                                fontSize: 16,
                                color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#333333'
                            }
                        },
                        series: []
                    });
                    return;
                }

                // 간단한 차트 옵션 설정
                integratedChart.setOption({
                    backgroundColor: 'transparent',
                    title: {
                        text: chartTitle,
                        left: 'center',
                        top: '3%',
                        textStyle: {
                            fontSize: 16,
                            fontWeight: 'bold',
                            color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#92400e'
                        }
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        },
                        formatter: function(params) {
                            const data = params[0];
                            return `${data.name}<br/>사용량: ${data.value}개`;
                        }
                    },
                    grid: {
                        left: '8%',
                        right: '8%',
                        bottom: '15%',
                        top: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: partNames,
                        axisLabel: {
                            rotate: 45,
                            interval: 0,
                            color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#78350f'
                        },
                        axisLine: {
                            lineStyle: {
                                color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#d97706'
                            }
                        }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: {
                            color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#78350f'
                        },
                        axisLine: {
                            lineStyle: {
                                color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#d97706'
                            }
                        },
                        splitLine: {
                            lineStyle: {
                                color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.2)' : '#fed7aa',
                                type: 'dashed'
                            }
                        }
                    },
                    series: [
                        {
                            name: '부품 사용량',
                            type: 'bar',
                            data: usageData.map((value, index) => {
                                // 랜덤 색상 배열
                                const colors = [
                                    '#f97316', '#ef4444', '#3b82f6', '#10b981', '#8b5cf6',
                                    '#ec4899', '#14b8a6', '#f59e0b', '#6366f1', '#84cc16',
                                    '#06b6d4', '#f43f5e', '#8b5cf6', '#22c55e', '#eab308'
                                ];
                                return {
                                    value: value,
                                    itemStyle: {
                                        color: colors[index % colors.length],
                                        borderRadius: [4, 4, 0, 0]
                                    }
                                };
                            }),
                            emphasis: {
                                itemStyle: {
                                    opacity: 0.8
                                }
                            },
                            barMaxWidth: 50
                        }
                    ]
                });

                console.log('Board별 부품 사용량 차트 업데이트 완료');
                
            } catch (error) {
                console.error('Board별 부품 사용량 차트 업데이트 중 오류:', error);
                
                // 오류 차트 표시
                integratedChart.setOption({
                    title: {
                        text: '🤖 AI 차트 업데이트 중 오류가 발생했습니다',
                        left: 'center',
                        textStyle: {
                            fontSize: 16,
                            color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#ff4757'
                        }
                    },
                    series: []
                });
            }
        }

        // 사용자 인증 확인 함수
        async function checkUserAuthentication() {
            try {
                console.log('사용자 인증 상태 확인 중...');
                const authStatus = await window.partsAPI.checkAuthStatus();

                if (!authStatus.isAuthenticated) {
                    // 인증되지 않았으면 로그인 페이지로 리다이렉트
                    console.log('인증되지 않은 사용자 - 로그인 페이지로 이동');
                    window.location.href = 'login.html';
                    return;
                }

                // 사용자 정보 표시
                const currentUserElement = document.getElementById('currentUser');
                if (currentUserElement && authStatus.user) {
                    currentUserElement.textContent = `${authStatus.user.username} (${authStatus.user.role})`;
                    console.log('사용자 정보 표시됨:', authStatus.user);
                }
            } catch (error) {
                console.error('인증 상태 확인 중 오류:', error);
                // 오류 발생 시에도 로그인 페이지로 이동
                window.location.href = 'login.html';
            }
        }

        // 로그아웃 함수
        async function logout() {
            try {
                console.log('로그아웃 요청...');
                const result = await window.partsAPI.userLogout();

                if (result.success) {
                    console.log('로그아웃 성공');
                    // 로그인 페이지로 리다이렉트
                    window.location.href = 'login.html';
                } else {
                    console.error('로그아웃 실패:', result.error);
                    alert('로그아웃 중 오류가 발생했습니다.');
                }
            } catch (error) {
                console.error('로그아웃 중 오류:', error);
                // 오류가 있어도 로그인 페이지로 이동
                window.location.href = 'login.html';
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded 이벤트 실행');

            // 인증 상태 확인 및 사용자 정보 로딩
            await checkUserAuthentication();

            // 날짜 필터 초기화 (다른 초기화보다 먼저 실행)
            await setupDateFilter();
            
            // 다크모드 토글 버튼 초기화
            const darkModeToggle = document.getElementById('darkModeToggle');
            console.log('다크모드 토글 버튼:', darkModeToggle);

            if (darkModeToggle) {
                // 기존 핸들러 제거 (이중 등록 방지)
                darkModeToggle.onclick = null;
                
                // 새 핸들러 등록
                darkModeToggle.onclick = function() {
                    console.log('다크모드 토글 버튼 클릭됨');
                    
                    // 현재 테마 확인
                    const isDarkMode = document.documentElement.classList.contains('dark');
                    console.log('현재 다크모드 상태:', isDarkMode);
                    
                    // 아이콘 요소 가져오기
                    const moonIcon = document.getElementById('moonIcon');
                    const sunIcon = document.getElementById('sunIcon');
                    
                    if (isDarkMode) {
                        // 다크모드 -> 라이트모드 전환
                        document.documentElement.classList.remove('dark');
                        localStorage.theme = 'light';
                        console.log('라이트 모드로 전환됨');
                        
                        // 아이콘 전환: 달 표시, 해 숨김
                        moonIcon.style.display = 'inline-block';
                        sunIcon.style.display = 'none';
                    } else {
                        // 라이트모드 -> 다크모드 전환
                        document.documentElement.classList.add('dark');
                        localStorage.theme = 'dark';
                        console.log('다크 모드로 전환됨');
                        
                        // 아이콘 전환: 달 숨김, 해 표시
                        moonIcon.style.display = 'none';
                        sunIcon.style.display = 'inline-block';
                    }
                      // 여기에 차트 업데이트 코드 추가
                    updateStockChart();
                    // 현재 선택된 년도로 차트 업데이트
                    const yearSelect = document.getElementById('categoryYearSelect');
                    const selectedYear = yearSelect ? yearSelect.value : 'all';
                    updateFlowChart(selectedYear);
                    updateBoardUsageChart();
                };
            }
               
            // 차트 초기화
            const stockChart = echarts.init(document.getElementById('stockChart'));
            const flowChart = echarts.init(document.getElementById('flowChart'));
            
            // 재고 현황 차트 초기 설정 (데이터 로딩 전 표시)
            stockChart.setOption({
                animation: false,
                tooltip: {
                    trigger: 'item'
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    data: [
                        { value: 1, name: '데이터 로딩 중...' }
                    ],
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            });

            // 실제 데이터로 재고 현황 차트 업데이트
            await updateStockChart();
            
            // 입출고 현황 차트 초기 설정 (데이터 로딩 전 표시)
            flowChart.setOption({
                animation: false,
                title: {
                    text: '데이터 로딩 중...',
                    left: 'center',
                    textStyle: {
                        fontSize: 14,
                        color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#333333'
                    }
                }
            });

            // 실제 데이터로 입출고 현황 차트 업데이트
            await updateFlowChart();
            
            // 창 크기 변경 시 차트 크기 조정
            window.addEventListener('resize', function() {
                stockChart.resize();
                flowChart.resize();
            });
            
            // 모달 관련 기능
            const modal = document.getElementById('modal');
            const openModalButton = document.getElementById('openModalButton');
            const cancelButton = document.getElementById('cancelButton');
            const partForm = document.getElementById('partForm');
            
            if (openModalButton) {
                openModalButton.addEventListener('click', () => {
                    modal.classList.remove('hidden');
                });
            }
            
            if (cancelButton) {
                cancelButton.addEventListener('click', () => {
                    modal.classList.add('hidden');
                });
            }
            
            if (partForm) {
                partForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    // 폼 처리 코드...
                    modal.classList.add('hidden');
                    partForm.reset();
                });
            }
            
            // 로고 이미지 클릭 시 페이지 새로고침
            const homeRefreshButton = document.getElementById('homeRefreshButton');
            if (homeRefreshButton) {
                homeRefreshButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('페이지 새로고침');
                    window.location.reload(true);
                });
            }

            // 실시간 알림 업데이트
            await updateAlerts();

            // 알림 버튼 및 드롭다운 초기화
            setupNotifications();

            // 카테고리 모달 초기화
            setupCategoryModal();

            // 메신저 기능 초기화 (이 부분을 추가)
            setupMessenger();            // 채팅 히스토리 테이블 초기화 및 필터 설정 (이 부분 추가)
            await updateChatHistoryTable();
            setupChatHistoryFilter();

            // Board별 부품 사용량 차트 초기화
            await updateBoardUsageChart();

            // 채팅 히스토리 필터링 초기화
            setupChatHistoryFilter();

            // 채팅 히스토리 테이블 업데이트
            await updateChatHistoryTable();

            // 카테고리별 구매금액 차트 년도&월 필터 초기화
            console.log('카테고리 년도&월 필터 초기화 시작...');
            await initializeCategoryYearFilter();
            console.log('카테고리 년도&월 필터 초기화 완료');

            // 입출고 현황 차트 업데이트 (전체 년도)
            await updateFlowChart('all');

            // 초기 차트 업데이트 (날짜 필터와 함께)
            await updateAllChartsWithDateFilter();
        });

        // 카테고리별 구매금액 차트 년도 필터 초기화 함수
        async function initializeCategoryYearFilter() {
            try {
                // 입출고 내역 데이터 가져오기
                const result = await window.partsAPI.getHistoryData();
                if (!result.success || !result.data) {
                    console.error('입출고 내역 데이터를 가져오는데 실패했습니다.');
                    return;
                }

                console.log('년도 필터 초기화 - 데이터 개수:', result.data.length);

                // 년도 추출
                const years = new Set();
                result.data.forEach(item => {
                    if (item.date) {
                        try {
                            let dateObj;
                            if (item.date instanceof Date) {
                                dateObj = item.date;
                            } else if (typeof item.date === 'string') {
                                dateObj = new Date(item.date);
                            } else {
                                return;
                            }

                            const year = dateObj.getFullYear();
                            if (!isNaN(year) && year > 2000 && year < 2100) {
                                years.add(year);
                            }
                        } catch (e) {
                            console.warn('날짜 파싱 실패:', item.date, e);
                        }
                    }
                });

                console.log('추출된 년도들:', Array.from(years));

                // 년도를 배열로 변환하고 내림차순 정렬
                const sortedYears = Array.from(years).sort((a, b) => b - a);

                // 년도 콤보박스에 옵션 추가
                const yearSelect = document.getElementById('categoryYearSelect');
                if (yearSelect) {
                    sortedYears.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;  // "년" 제거
                        yearSelect.appendChild(option);
                    });
                    console.log('년도 옵션 추가 완료:', sortedYears.length, '개');

                    // 년도 변경 시 차트 업데이트
                    yearSelect.addEventListener('change', async (e) => {
                        const selectedYear = e.target.value;
                        console.log('년도 필터 변경:', selectedYear);
                        await updateFlowChart(selectedYear);
                    });
                }

            } catch (error) {
                console.error('년도 필터 초기화 중 오류:', error);
            }
        }

        // 카테고리별 출고 분포 모달 관련 함수들
        function showCategoryModal(selectedMonth, allData) {
            try {
                console.log('카테고리 모달 표시 시작:', selectedMonth);
                
                const modal = document.getElementById('categoryModal');
                const modalTitle = document.getElementById('categoryModalTitle');
                const categoryList = document.getElementById('categoryList');
                
                if (!modal || !modalTitle || !categoryList) {
                    console.error('카테고리 모달 요소를 찾을 수 없습니다.');
                    console.error('modal:', modal, 'modalTitle:', modalTitle, 'categoryList:', categoryList);
                    return;
                }
                
                console.log('모달 요소들이 정상적으로 찾아졌습니다.');
                
                // 모달 제목 설정
                const [year, month] = selectedMonth.split('.');
                modalTitle.textContent = `${year}년 ${month}월 카테고리별 출고 현황`;
                console.log('모달 제목 설정:', modalTitle.textContent);
                
                // 해당 월의 출고 데이터 필터링
                const monthData = allData.filter(item => {
                    if (!item.date || !item.type) return false;
                    
                    try {
                        const itemDate = new Date(item.date);
                        if (isNaN(itemDate.getTime())) return false;
                        
                        const itemYearMonth = `${itemDate.getFullYear()}.${String(itemDate.getMonth() + 1).padStart(2, '0')}`;
                        const type = (item.type || '').toLowerCase();
                        
                        return itemYearMonth === selectedMonth && 
                               (type === '출고' || type === 'out' || type === 'outflow');
                    } catch (error) {
                        return false;
                    }
                });
                
                console.log(`${selectedMonth} 출고 데이터:`, monthData);
                
                // 카테고리별 집계
                const categoryData = {};
                let totalQuantity = 0;
                
                monthData.forEach(item => {
                    const categoryName = item.category || item.name || '기타';
                    
                    // 수량 추출
                    let quantity = 0;
                    const possibleFields = ['quantity', 'count', 'amount', 'stock', 'value'];
                    
                    for (const field of possibleFields) {
                        if (item[field] !== undefined && item[field] !== null) {
                            const rawValue = item[field];
                            if (!isNaN(Number(rawValue))) {
                                quantity = Number(rawValue);
                                break;
                            } else if (typeof rawValue === 'string') {
                                const matches = rawValue.match(/\d+/);
                                if (matches && matches.length > 0) {
                                    quantity = Number(matches[0]);
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (quantity === 0) quantity = 1;
                    
                    if (!categoryData[categoryName]) {
                        categoryData[categoryName] = 0;
                    }
                    categoryData[categoryName] += quantity;
                    totalQuantity += quantity;
                });
                
                console.log('카테고리별 집계 결과:', categoryData, '총 수량:', totalQuantity);
                
                // 데이터가 없는 경우 테스트 데이터 생성
                if (Object.keys(categoryData).length === 0) {
                    console.log('실제 데이터가 없어 테스트 데이터 생성');
                    categoryData = {
                        'PCB': 15,
                        'IC': 10,
                        '저항': 8,
                        '콘덴서': 5,
                        '기타': 3
                    };
                    totalQuantity = Object.values(categoryData).reduce((sum, val) => sum + val, 0);
                }
                
                // 차트 데이터 생성
                const chartData = Object.entries(categoryData).map(([name, value]) => ({
                    name: name,
                    value: value
                })).sort((a, b) => b.value - a.value);
                
                console.log('카테고리 차트 데이터:', chartData);
                
                // 모달 먼저 표시 (차트 컨테이너가 렌더링되도록)
                modal.classList.remove('hidden');
                console.log('모달 표시됨');
                
                // 모달 표시 즉시 강제 흰색 적용
                forceWhiteTextInDarkMode();
                
                // 10ms 후 다시 적용
                setTimeout(() => {
                    forceWhiteTextInDarkMode();
                }, 10);
                
                // 50ms 후 다시 적용
                setTimeout(() => {
                    forceWhiteTextInDarkMode();
                }, 50);
                
                // 모달이 완전히 렌더링된 후 차트 그리기 (약간의 지연)
                setTimeout(() => {
                    console.log('차트 그리기 시작');
                    
                    // 차트 컨테이너 확인
                    const chartContainer = document.getElementById('categoryChart');
                    console.log('차트 컨테이너:', chartContainer);
                    console.log('차트 컨테이너 크기:', chartContainer ? chartContainer.getBoundingClientRect() : 'null');
                    
                    // 차트 그리기
                    updateCategoryChart(chartData, totalQuantity);
                    
                    // 상세 정보 업데이트
                    updateCategoryDetails(chartData, totalQuantity);
                    
                    // 차트 렌더링 후 여러 번 강제 적용
                    setTimeout(() => forceWhiteTextInDarkMode(), 50);
                    setTimeout(() => forceWhiteTextInDarkMode(), 100);
                    setTimeout(() => forceWhiteTextInDarkMode(), 200);
                    setTimeout(() => forceWhiteTextInDarkMode(), 500);
                    setTimeout(() => forceWhiteTextInDarkMode(), 1000);
                }, 100);
                
            } catch (error) {
                console.error('카테고리 모달 표시 중 오류:', error);
            }
        }
        
        function updateCategoryChart(chartData, totalQuantity) {
            try {
                const chartContainer = document.getElementById('categoryChart');
                if (!chartContainer) {
                    console.error('카테고리 차트 컨테이너를 찾을 수 없습니다.');
                    return;
                }
                
                // 기존 차트 인스턴스가 있다면 제거
                if (window.categoryChartInstance) {
                    window.categoryChartInstance.dispose();
                }
                
                // 새 차트 인스턴스 생성
                window.categoryChartInstance = echarts.init(chartContainer);
                
                console.log('카테고리 차트 데이터 확인:', chartData, '총량:', totalQuantity);
                
                if (chartData.length === 0) {
                    window.categoryChartInstance.setOption({
                        title: {
                            text: '해당 월에 출고 데이터가 없습니다',
                            left: 'center',
                            top: 'middle',
                            textStyle: {
                                fontSize: 18,
                                fontWeight: 'bold',
                                color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#374151'
                            }
                        }
                    });
                    return;
                }
                
                // 파이 차트 설정
                window.categoryChartInstance.setOption({
                    animation: true,
                    animationDuration: 1000,
                    animationEasing: 'cubicOut',
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            const percentage = ((params.value / totalQuantity) * 100).toFixed(1);
                            return `
                                <div style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    border: none;
                                    border-radius: 8px;
                                    padding: 10px;
                                    color: white;
                                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                                ">
                                    <div style="font-weight: bold; margin-bottom: 5px;">
                                        📦 ${params.name}
                                    </div>
                                    <div>출고량: ${params.value}개</div>
                                    <div>비율: ${percentage}%</div>
                                </div>
                            `;
                        },
                        backgroundColor: 'transparent',
                        borderColor: 'transparent'
                    },
                    legend: {
                        orient: 'horizontal',
                        bottom: '5%',
                        left: 'center',
                        itemWidth: 14,
                        itemHeight: 14,
                        textStyle: {
                            color: document.documentElement.classList.contains('dark') ? '#ffffff' : '#333333',  // 다크모드에 따라 조건부 색상
                            fontSize: 12,
                            fontWeight: 'bold'
                        },
                        inactiveColor: document.documentElement.classList.contains('dark') ? '#666666' : '#cccccc',  // 다크모드에 따라 조건부 비활성 색상
                        formatter: function(name) {
                            return document.documentElement.classList.contains('dark') ? `{dark|${name}}` : `{light|${name}}`;
                        },
                        rich: {
                            dark: {
                                color: '#ffffff'  // 다크모드용 리치 텍스트
                            },
                            light: {
                                color: '#333333'  // 라이트모드용 리치 텍스트
                            }
                        }
                    },
                    series: [{
                        name: '카테고리별 출고량',
                        type: 'pie',
                        radius: ['25%', '55%'],
                        center: ['50%', '50%'],
                        avoidLabelOverlap: true,
                        itemStyle: {
                            borderRadius: 8,
                            borderColor: '#fff',
                            borderWidth: 2,
                            shadowBlur: 20,
                            shadowColor: 'rgba(0, 0, 0, 0.3)'
                        },
                        label: {
                            show: false
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: 13,
                                fontWeight: 'bold'
                            },
                            itemStyle: {
                                shadowBlur: 30,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        },
                        data: chartData.map((item, index) => ({
                            ...item,
                            itemStyle: {
                                color: function() {
                                    const colors = [
                                        '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', 
                                        '#FECA57', '#A29BFE', '#FD79A8', '#E17055',
                                        '#74B9FF', '#55A3FF', '#26D0CE', '#6C5CE7'
                                    ];
                                    return colors[index % colors.length];
                                }()
                            }
                        }))
                    }]
                });
                
                // 차트 크기 재조정 (모달 크기에 맞춤)
                setTimeout(() => {
                    if (window.categoryChartInstance) {
                        window.categoryChartInstance.resize();
                        console.log('카테고리 차트 크기 재조정 완료');
                        
                        // 차트 렌더링 완료 후 강제로 여러 번 흰색 적용
                        setTimeout(() => forceWhiteTextInDarkMode(), 10);
                        setTimeout(() => forceWhiteTextInDarkMode(), 50);
                        setTimeout(() => forceWhiteTextInDarkMode(), 100);
                        setTimeout(() => forceWhiteTextInDarkMode(), 200);
                        setTimeout(() => forceWhiteTextInDarkMode(), 500);
                        
                        // ECharts 범례 텍스트 색상 강제 적용
                        setTimeout(() => forceEChartsLegendColor(), 10);
                        setTimeout(() => forceEChartsLegendColor(), 50);
                        setTimeout(() => forceEChartsLegendColor(), 100);
                        setTimeout(() => forceEChartsLegendColor(), 200);
                        setTimeout(() => forceEChartsLegendColor(), 500);
                        setTimeout(() => forceEChartsLegendColor(), 1000);
                    }
                }, 50);
                
            } catch (error) {
                console.error('카테고리 차트 업데이트 중 오류:', error);
            }
        }
        
        function updateCategoryDetails(chartData, totalQuantity) {
            try {
                const categoryList = document.getElementById('categoryList');
                if (!categoryList) return;
                
                categoryList.innerHTML = '';
                
                if (chartData.length === 0) {
                    categoryList.innerHTML = '<div class="text-center py-8 text-gray-600 dark:text-white font-medium text-lg">📭 출고 데이터가 없습니다.</div>';
                    return;
                }
                
                chartData.forEach((item, index) => {
                    const percentage = ((item.value / totalQuantity) * 100).toFixed(1);
                    const colors = [
                        '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', 
                        '#FECA57', '#A29BFE', '#FD79A8', '#E17055',
                        '#74B9FF', '#55A3FF', '#26D0CE', '#6C5CE7'
                    ];
                    const color = colors[index % colors.length];
                    
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex items-center justify-between p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm';
                    itemElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-4 h-4 rounded-full mr-3 border-2 border-white shadow-md" style="background-color: ${color}"></div>
                            <span class="font-bold text-gray-800 dark:text-white">${item.name}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg text-gray-900 dark:text-white">${item.value}개</div>
                            <div class="text-sm text-gray-600 dark:text-white font-medium">${percentage}%</div>
                        </div>
                    `;
                    categoryList.appendChild(itemElement);
                });
                
            } catch (error) {
                console.error('카테고리 상세 정보 업데이트 중 오류:', error);
            }
        }
        
        // 다크모드에서 모든 텍스트를 무조건 흰색으로 강제 적용하는 함수
        function forceWhiteTextInDarkMode() {
            if (!document.documentElement.classList.contains('dark')) {
                return; // 다크모드가 아니면 실행하지 않음
            }
            
            console.log('🔥 다크모드에서 무조건 흰색 텍스트 강제 적용 시작!');
            
            const modal = document.getElementById('categoryModal');
            if (!modal) return;
            
            // 1. 모달 전체에 강제 흰색 적용
            modal.style.setProperty('color', '#ffffff', 'important');
            
            // 2. 모든 요소를 찾아서 무조건 흰색 적용
            const allElements = modal.querySelectorAll('*');
            console.log(`총 ${allElements.length}개 요소에 흰색 적용`);
            
            allElements.forEach((element, index) => {
                // 모든 요소에 무조건 흰색 적용
                element.style.setProperty('color', '#ffffff', 'important');
                element.style.setProperty('fill', '#ffffff', 'important');
                element.style.setProperty('text-shadow', '0 1px 3px rgba(0, 0, 0, 0.8)', 'important');
                
                // 모든 가능한 color 속성 강제 적용
                element.style.setProperty('--tw-text-opacity', '1', 'important');
                element.style.setProperty('stroke', '#ffffff', 'important');
                
                // 클래스 속성도 강제로 제거하고 인라인 스타일로 적용
                if (element.className && typeof element.className === 'string') {
                    // 색상 관련 클래스들 찾아서 제거
                    const colorClasses = element.className.split(' ').filter(cls => 
                        !cls.includes('text-') && 
                        !cls.includes('color-') && 
                        !cls.includes('fill-')
                    );
                    element.className = colorClasses.join(' ');
                }
                
                // 인라인 스타일로 다시 한번 강제 적용
                element.setAttribute('style', 
                    element.getAttribute('style') + 
                    '; color: #ffffff !important; fill: #ffffff !important; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8) !important;'
                );
            });
            
            // 3. 특정 태그들에 대해 추가로 강제 적용
            const textTags = ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'span', 'div', 'button', 'i', 'strong', 'b', 'em', 'label', 'a', 'li', 'td', 'th'];
            
            textTags.forEach(tag => {
                const elements = modal.querySelectorAll(tag);
                elements.forEach(element => {
                    element.style.setProperty('color', '#ffffff', 'important');
                    element.style.setProperty('fill', '#ffffff', 'important');
                    element.style.setProperty('text-shadow', '0 1px 3px rgba(0, 0, 0, 0.8)', 'important');
                    
                    // 텍스트 노드도 강제 적용
                    if (element.childNodes) {
                        element.childNodes.forEach(node => {
                            if (node.nodeType === Node.TEXT_NODE && node.parentElement) {
                                node.parentElement.style.setProperty('color', '#ffffff', 'important');
                            }
                        });
                    }
                });
            });
            
            // 4. ECharts 차트 내부 모든 텍스트 강제 흰색
            const chartContainer = modal.querySelector('#categoryChart');
            if (chartContainer) {
                // SVG 내부 모든 텍스트 요소
                const svgTexts = chartContainer.querySelectorAll('text, tspan, g, path, rect, circle');
                svgTexts.forEach(element => {
                    element.style.setProperty('fill', '#ffffff', 'important');
                    element.style.setProperty('color', '#ffffff', 'important');
                    element.style.setProperty('stroke', '#ffffff', 'important');
                    element.setAttribute('fill', '#ffffff');
                    element.setAttribute('color', '#ffffff');
                });
                
                // Canvas 기반 차트도 처리
                const canvasElements = chartContainer.querySelectorAll('canvas');
                canvasElements.forEach(canvas => {
                    canvas.style.setProperty('color', '#ffffff', 'important');
                });
                
                // ECharts 범례 텍스트 특별 처리
                setTimeout(() => {
                    const legendTexts = chartContainer.querySelectorAll('text[text-anchor], tspan, g[class*="legend"] text, g[class*="legend"] tspan');
                    legendTexts.forEach(element => {
                        element.style.setProperty('fill', '#ffffff', 'important');
                        element.setAttribute('fill', '#ffffff');
                        if (element.textContent && element.textContent.trim()) {
                            element.style.setProperty('color', '#ffffff', 'important');
                        }
                    });
                }, 100);
            }
            
            // 5. MutationObserver로 동적으로 추가되는 요소도 감시
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            node.style.setProperty('color', '#ffffff', 'important');
                            node.style.setProperty('fill', '#ffffff', 'important');
                            
                            // 하위 요소들도 모두 처리
                            const subElements = node.querySelectorAll('*');
                            subElements.forEach(subElement => {
                                subElement.style.setProperty('color', '#ffffff', 'important');
                                subElement.style.setProperty('fill', '#ffffff', 'important');
                            });
                        }
                    });
                });
            });
            
            observer.observe(modal, { 
                childList: true, 
                subtree: true, 
                attributes: true,
                attributeFilter: ['style', 'class']
            });
            
            // 6. 1초 후 한번 더 강제 적용 (차트 렌더링 완료 후)
            setTimeout(() => {
                allElements.forEach(element => {
                    element.style.setProperty('color', '#ffffff', 'important');
                    element.style.setProperty('fill', '#ffffff', 'important');
                });
            }, 1000);
            
            console.log('🔥 다크모드 무조건 흰색 텍스트 강제 적용 완료!');
        }

        // ECharts 범례 텍스트 색상 강제 적용 함수
        function forceEChartsLegendColor() {
            console.log('🎯 ECharts 범례 텍스트 색상 조건부 적용 시작');

            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#ffffff' : '#333333';
            const inactiveColor = isDarkMode ? '#666666' : '#cccccc';

            // 모든 ECharts 컨테이너 찾기
            const chartContainers = document.querySelectorAll('[id*="Chart"], .echarts-container, div[data-zr-dom-id]');
            
            chartContainers.forEach(container => {
                // SVG 요소 내 모든 텍스트
                const allTexts = container.querySelectorAll('text, tspan');
                allTexts.forEach(textElement => {
                    // 범례 텍스트로 보이는 것들 처리
                    if (textElement.textContent && textElement.textContent.trim()) {
                        textElement.style.setProperty('fill', textColor, 'important');
                        textElement.setAttribute('fill', textColor);
                        
                        // 부모 요소가 범례인지 확인
                        const parent = textElement.closest('g');
                        if (parent) {
                            parent.style.setProperty('fill', textColor, 'important');
                        }
                    }
                });

                // Canvas 기반 차트의 경우 - 다시 렌더링 트리거
                const canvasElements = container.querySelectorAll('canvas[data-zr-dom-id]');
                canvasElements.forEach(canvas => {
                    // Canvas 컨테이너에 조건부 색상 속성 추가
                    canvas.parentElement.style.setProperty('--legend-text-color', textColor, 'important');
                });
            });

            console.log(`🎯 ECharts 범례 텍스트 색상 ${isDarkMode ? '다크모드' : '라이트모드'} 적용 완료`);
        }
        
        // 카테고리 모달 초기화
        function setupCategoryModal() {
            const modal = document.getElementById('categoryModal');
            const closeButton = document.getElementById('closeCategoryModal');
            
            // 모달 닫기 공통 함수
            function closeCategoryModal() {
                modal.classList.add('hidden');
                // 차트 인스턴스 정리
                if (window.categoryChartInstance) {
                    window.categoryChartInstance.dispose();
                    window.categoryChartInstance = null;
                    console.log('카테고리 차트 인스턴스 정리됨');
                }
            }
            
            // X 버튼으로 모달 닫기
            if (closeButton) {
                closeButton.addEventListener('click', function() {
                    closeCategoryModal();
                });
            }
            
            // 모달 외부 클릭으로 닫기
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeCategoryModal();
                    }
                });
            }
        }

        // ESC 키로 모달 닫기
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' || e.keyCode === 27) {
                // 카테고리 모달 닫기
                const categoryModal = document.getElementById('categoryModal');
                if (categoryModal && !categoryModal.classList.contains('hidden')) {
                    categoryModal.classList.add('hidden');
                    // 차트 인스턴스 정리
                    if (window.categoryChartInstance) {
                        window.categoryChartInstance.dispose();
                        window.categoryChartInstance = null;
                        console.log('ESC로 카테고리 차트 인스턴스 정리됨');
                    }
                }
                
                // 챗봇 모달 닫기
                const chatModal = document.getElementById('chatModal');
                if (chatModal && !chatModal.classList.contains('hidden')) {
                    chatModal.classList.add('hidden');
                }
            }
        });
    </script>
</body>
</html>
